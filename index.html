<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phoenix Chat</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🔥</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@latest/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@latest/dist/purify.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* CSS Variables para Theming */
        :root {
            --bg-primary: #ffffff; --bg-secondary: #f8f9fa; --bg-tertiary: #e9ecef;
            --text-primary: #212529; --text-secondary: #495057;
            --border-color: #dee2e6;
            --accent-pro: #fd7e14;
        }
        .dark {
            --bg-primary: #131314; --bg-secondary: #1e1f20; --bg-tertiary: #35363a;
            --text-primary: #e8eaed; --text-secondary: #9aa0a6;
            --border-color: #4a4a4e;
            --accent-pro: #fbbc04;
        }

        /* Estilos Gerais */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-primary); 
            color: var(--text-primary);
        }
        .chat-bubble-user { background-color: #3b82f6; color: white; }
        .chat-bubble-ai { background-color: var(--bg-tertiary); color: var(--text-primary); }
        .chat-bubble-ai-pro { background-color: #4a3c1a; border: 1px solid var(--accent-pro); color: #fef08a; }
        .dark .chat-bubble-ai-pro { background-color: #4a3c1a; }
        
        /* Estilos do Markdown */
        .markdown-content h1, .markdown-content h2, .markdown-content h3 { font-weight: bold; margin-top: 1rem; margin-bottom: 0.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.25rem;}
        .markdown-content p { margin-bottom: 0.75rem; line-height: 1.6; }
        .markdown-content ul, .markdown-content ol { margin-left: 1.5rem; margin-bottom: 0.75rem; }
        .markdown-content code:not(pre > code) { background-color: var(--bg-secondary); padding: 0.2em 0.4em; border-radius: 3px; font-family: 'Courier New', Courier, monospace; }
        .markdown-content pre { background-color: var(--bg-secondary); padding: 1rem; border-radius: 8px; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;}
        .markdown-content a { color: #8ab4f8; text-decoration: underline; }

        /* Estilos de Componentes da UI */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #5f6368; border-radius: 4px; }
        .modal-overlay { transition: opacity 0.3s ease; }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        .toggle-bg:after { content: ''; position: absolute; top: 2px; left: 2px; background: white; border-radius: 50%; height: 1.25rem; width: 1.25rem; transition: 0.2s; }
        input:checked + .toggle-bg:after { transform: translateX(100%); }
        input:checked + .toggle-bg { background-color: #34d399; }
        .resizer { background-color: var(--border-color); width: 4px; cursor: col-resize; z-index: 10; opacity: 0.5; transition: opacity 0.2s; }
        .resizer:hover { opacity: 1; }
        .panel-hidden { display: none !important; }
        .chat-list-item.active { background-color: var(--bg-tertiary); }
        .view-btn.active { background-color: var(--bg-tertiary); color: var(--text-primary); }
        
        /* Canvas Mode Styles */
        .canvas-mode #main-chat-panel { width: 300px; flex-shrink: 0; }
        .canvas-mode #canvas-panel { flex: 1; }
        .canvas-mode #right-panel-container { flex: 1; }
    </style>
</head>
<body class="flex flex-row h-screen antialiased overflow-hidden">
    
    <!-- Coluna 1: Barra Lateral Esquerda (Chats e Configurações) -->
    <div id="left-sidebar" class="flex flex-col w-64 bg-[var(--bg-secondary)] flex-shrink-0">
        <div id="chat-list-panel" class="flex flex-col flex-grow p-2">
            <div class="flex items-center justify-between p-2 border-b border-[var(--border-color)]">
                <h2 class="text-xl font-bold text-[var(--text-primary)]">Chats</h2>
                <div class="flex items-center">
                    <button id="newChatBtn" class="p-2 rounded-md hover:bg-[var(--bg-tertiary)] text-[var(--text-secondary)]" title="Novo Chat">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                    </button>
                    <button id="collapse-chat-list-btn" class="p-2 rounded-md hover:bg-[var(--bg-tertiary)] text-[var(--text-secondary)]" title="Recolher Chats">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path></svg>
                    </button>
                </div>
            </div>
            <div id="chat-list-container" class="flex-grow overflow-y-auto custom-scrollbar">
                <!-- Os chats serão inseridos aqui pelo JS -->
            </div>
        </div>
        <div class="p-2 border-t border-[var(--border-color)]">
            <button id="settings-btn" class="w-full flex items-center p-2 rounded-md hover:bg-[var(--bg-tertiary)] text-[var(--text-secondary)]" title="Configurações">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                <span>Configurações</span>
            </button>
        </div>
    </div>
    
    <!-- Botão para reabrir a lista de chats -->
    <button id="expand-chat-list-btn" class="panel-hidden absolute top-2 left-2 z-20 p-2 bg-gray-700 rounded-md hover:bg-gray-600" title="Expandir Chats">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path></svg>
    </button>
    
    <!-- Puxador de redimensionamento -->
    <div id="main-resizer" class="resizer"></div>

    <!-- Container Principal (Chat + Painel Direito) -->
    <div id="main-container" class="flex flex-auto flex-row h-full">

        <!-- Coluna 2: Chat Principal -->
        <div id="main-chat-panel" class="flex flex-col flex-auto h-full p-4 transition-all duration-300 ease-in-out">
            <div class="flex flex-col flex-auto flex-shrink-0 rounded-2xl bg-[var(--bg-secondary)] h-full p-4 shadow-2xl">
                <div class="flex flex-col h-full overflow-hidden">
                    <div class="text-center py-2 border-b border-[var(--border-color)]">
                        <div class="flex justify-center items-center space-x-2">
                            <h1 id="main-title" class="text-2xl font-bold text-[var(--text-primary)]">Phoenix Chat</h1>
                            <button id="proModeBtn" title="Ativar Modo Pro" class="text-[var(--text-secondary)] hover:text-[var(--accent-pro)]">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div id="chat-container" class="flex flex-col h-full overflow-y-auto mb-4 custom-scrollbar">
                         <div id="chat-messages" class="flex flex-col space-y-4 p-3">
                            <div id="chat-placeholder" class="flex flex-col items-center justify-center h-full text-[var(--text-secondary)]">
                                <svg class="w-24 h-24 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5-2.5-7S3 7 3 7a8 8 0 0110.657 10.657l3.414 3.414a2 2 0 01-2.828 2.828l-3.414-3.414zM4 4l16 16"/>
                                </svg>
                                <p>Selecione um chat ou crie um novo para começar.</p>
                            </div>
                        </div>
                    </div>
                    <div id="attachment-preview-container" class="p-2 border-t border-[var(--border-color)] hidden"></div>
                    <div class="flex flex-row items-end pt-4 border-t border-[var(--border-color)]">
                        <button id="attachFileBtn" class="p-2 rounded-full hover:bg-[var(--bg-tertiary)] mr-2 flex-shrink-0 text-[var(--text-secondary)]" title="Anexar Imagem">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                            </svg>
                        </button>
                        <input type="file" id="file-input" class="hidden" accept="image/*">
                        <div class="flex-grow relative">
                            <textarea id="userInput" class="w-full border border-[var(--border-color)] bg-[var(--bg-tertiary)] rounded-xl focus:outline-none focus:border-indigo-500 p-3 pr-12 text-[var(--text-primary)] resize-none" placeholder="Digite sua mensagem..." rows="1"></textarea>
                            <button id="sendButton" class="absolute right-2 bottom-2 flex items-center justify-center bg-indigo-600 hover:bg-indigo-700 rounded-lg text-white p-2">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.428A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                 </div>
            </div>
        </div>
        
        <!-- Puxador para redimensionar o painel direito -->
        <div id="right-panel-resizer" class="resizer panel-hidden"></div>

        <!-- Coluna 3: Painel Direito (Memória/Canvas) -->
        <div id="right-panel-container" class="flex-col w-96 bg-[var(--bg-secondary)] p-2 transition-all duration-300 ease-in-out flex-shrink-0 hidden md:flex">
            <div class="flex items-center justify-between p-2 border-b border-[var(--border-color)]">
                <div class="flex space-x-1">
                    <button id="view-memory-btn" class="px-3 py-1 text-sm font-semibold rounded-md view-btn">Memória</button>
                    <button id="view-canvas-btn" class="px-3 py-1 text-sm font-semibold rounded-md view-btn">Canvas</button>
                </div>
                <button id="close-right-panel-btn" class="p-2 rounded-md hover:bg-[var(--bg-tertiary)] text-[var(--text-secondary)]" title="Fechar Painel">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div id="memory-panel" class="flex-grow flex-col hidden">
                <div class="p-2 flex space-x-2 items-center justify-between">
                    <input type="text" id="memorySearch" class="w-full border border-[var(--border-color)] bg-[var(--bg-tertiary)] rounded-lg px-3 py-2 text-sm text-[var(--text-primary)]" placeholder="Buscar...">
                    <button id="addMemoryBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-lg text-sm">Add</button>
                </div>
                <div id="memory-container" class="flex-grow overflow-y-auto custom-scrollbar"></div>
            </div>
            
            <div id="canvas-panel" class="flex-grow flex-col hidden">
                <div id="canvas-content" class="flex-grow p-4 bg-white text-gray-800 rounded-md custom-scrollbar overflow-y-auto">
                    <p class="text-center text-gray-500">O Canvas está vazio.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modais -->
    <div id="renameModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50">
        <div class="bg-[#2d2d30] p-6 rounded-lg shadow-xl w-1/3 text-[var(--text-primary)]">
            <h3 class="text-lg font-bold mb-4">Renomear Chat</h3>
            <input type="text" id="renameInput" class="w-full border border-gray-600 bg-[var(--bg-tertiary)] rounded-lg p-2 mb-4" placeholder="Novo nome do chat...">
            <div class="flex justify-end space-x-2">
                <button id="cancelRename" class="px-4 py-2 bg-gray-600 rounded-lg">Cancelar</button>
                <button id="confirmRename" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">Salvar</button>
            </div>
        </div>
    </div>
    
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50">
        <div class="bg-[#2d2d30] p-6 rounded-lg shadow-xl w-1/3 text-[var(--text-primary)]">
            <h3 class="text-lg font-bold mb-4 border-b border-[var(--border-color)] pb-2">Configurações</h3>
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <label for="theme-toggle" class="font-medium">Tema Escuro</label>
                    <label for="theme-toggle" class="flex items-center cursor-pointer">
                        <div class="relative">
                            <input type="checkbox" id="theme-toggle" class="sr-only">
                            <div class="block bg-gray-600 w-10 h-6 rounded-full toggle-bg"></div>
                        </div>
                    </label>
                </div>
                <div class="flex items-center justify-between">
                    <label for="auto-memory-toggle-input" class="font-medium">Memória Automática</label>
                     <label for="auto-memory-toggle-input" class="flex items-center cursor-pointer">
                        <div class="relative">
                            <input type="checkbox" id="auto-memory-toggle-input" class="sr-only">
                            <div class="block bg-gray-600 w-10 h-6 rounded-full toggle-bg"></div>
                        </div>
                    </label>
                </div>
                 <div class="flex items-center justify-between">
                    <label for="global-pro-mode-toggle-input" class="font-medium">Modo Profissional Global</label>
                     <label for="global-pro-mode-toggle-input" class="flex items-center cursor-pointer">
                        <div class="relative">
                            <input type="checkbox" id="global-pro-mode-toggle-input" class="sr-only">
                            <div class="block bg-gray-600 w-10 h-6 rounded-full toggle-bg"></div>
                        </div>
                    </label>
                </div>
            </div>
             <div class="flex justify-end mt-6">
                <button id="closeSettings" class="px-6 py-2 bg-indigo-600 text-white rounded-lg">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Outros Modais -->
    <div id="memoryModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50">
        <div class="bg-[#2d2d30] p-6 rounded-lg shadow-xl w-1/3 text-gray-200">
            <h3 class="text-lg font-bold mb-4">Salvar Memória Manual</h3>
            <textarea id="memoryText" class="w-full border border-gray-600 bg-[var(--bg-tertiary)] rounded-lg p-2 h-32 mb-4" placeholder="Texto da memória..."></textarea>
            <input type="text" id="memoryTopics" class="w-full border border-gray-600 bg-[var(--bg-tertiary)] rounded-lg p-2 mb-4" placeholder="Tópicos (separados por vírgula)...">
            <div class="flex justify-end space-x-2">
                <button id="cancelSave" class="px-4 py-2 bg-gray-600 rounded-lg">Cancelar</button>
                <button id="confirmSave" class="px-4 py-2 bg-green-600 text-white rounded-lg">Salvar</button>
            </div>
        </div>
    </div>
    
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50">
        <div class="bg-[#2d2d30] p-6 rounded-lg shadow-xl w-1/3 text-gray-200">
            <h3 class="text-lg font-bold mb-4">Confirmar Ação</h3>
            <p id="confirmMessage" class="mb-4">Você tem certeza?</p>
            <div class="flex justify-end space-x-2">
                <button id="cancelConfirm" class="px-4 py-2 bg-gray-600 rounded-lg">Cancelar</button>
                <button id="doConfirm" class="px-4 py-2 bg-red-600 text-white rounded-lg">Confirmar</button>
            </div>
        </div>
    </div>
    
    <div id="passwordModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50">
        <div class="bg-[#2d2d30] p-6 rounded-lg shadow-xl w-1/3 text-gray-200">
            <h3 class="text-lg font-bold mb-4">Ativar Modo Pro</h3>
            <p class="text-sm text-gray-400 mb-4">Digite a senha para usar o modelo Pro.</p>
            <input type="password" id="proPasswordInput" class="w-full border border-gray-600 bg-[var(--bg-tertiary)] rounded-lg p-2 mb-4" placeholder="Senha...">
            <div class="flex justify-end space-x-2">
                <button id="cancelPassword" class="px-4 py-2 bg-gray-600 rounded-lg">Cancelar</button>
                <button id="confirmPassword" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">Verificar</button>
            </div>
        </div>
    </div>
    
    <div id="notificationModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50">
        <div class="bg-[#2d2d30] p-6 rounded-lg shadow-xl w-1/3 text-gray-200 text-center">
            <p id="notificationMessage" class="mb-4 font-semibold"></p>
            <button id="closeNotification" class="px-6 py-2 bg-indigo-600 text-white rounded-lg">OK</button>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Estado global da aplicação
            let appState = {
                activeChatId: null,
                chats: {},
                settings: {
                    theme: 'dark',
                    globalProMode: false,
                    isProMode: false,
                    proModeToken: null,
                    autoMemory: false
                },
                activeRightPanelView: 'memory',
                isCanvasMode: false
            };

            // Seletores de elementos
            const elements = {
                body: document.body,
                leftSidebar: document.getElementById('left-sidebar'),
                chatListPanel: document.getElementById('chat-list-panel'),
                mainContainer: document.getElementById('main-container'),
                mainChatPanel: document.getElementById('main-chat-panel'),
                rightPanelContainer: document.getElementById('right-panel-container'),
                chatMessages: document.getElementById('chat-messages'),
                chatPlaceholder: document.getElementById('chat-placeholder'),
                memoryPanel: document.getElementById('memory-panel'),
                canvasPanel: document.getElementById('canvas-panel'),
                canvasContent: document.getElementById('canvas-content'),
                memoryContainer: document.getElementById('memory-container'),
                chatListContainer: document.getElementById('chat-list-container'),
                userInput: document.getElementById('userInput'),
                attachmentPreview: document.getElementById('attachment-preview-container'),
                
                newChatBtn: document.getElementById('newChatBtn'),
                collapseChatListBtn: document.getElementById('collapse-chat-list-btn'),
                expandChatListBtn: document.getElementById('expand-chat-list-btn'),
                sendButton: document.getElementById('sendButton'),
                proModeBtn: document.getElementById('proModeBtn'),
                viewMemoryBtn: document.getElementById('view-memory-btn'),
                viewCanvasBtn: document.getElementById('view-canvas-btn'),
                closeRightPanelBtn: document.getElementById('close-right-panel-btn'),
                attachFileBtn: document.getElementById('attachFileBtn'),
                fileInput: document.getElementById('file-input'),
                
                passwordModal: document.getElementById('passwordModal'),
                proPasswordInput: document.getElementById('proPasswordInput'),
                confirmPassword: document.getElementById('confirmPassword'),
                cancelPassword: document.getElementById('cancelPassword'),
                notificationModal: document.getElementById('notificationModal'),
                notificationMessage: document.getElementById('notificationMessage'),
                closeNotification: document.getElementById('closeNotification'),
                
                memoryModal: document.getElementById('memoryModal'),
                memoryText: document.getElementById('memoryText'),
                memoryTopics: document.getElementById('memoryTopics'),
                cancelSave: document.getElementById('cancelSave'),
                confirmSave: document.getElementById('confirmSave'),
                
                confirmModal: document.getElementById('confirmModal'),
                confirmMessage: document.getElementById('confirmMessage'),
                cancelConfirm: document.getElementById('cancelConfirm'),
                doConfirm: document.getElementById('doConfirm'),
                
                renameModal: document.getElementById('renameModal'),
                renameInput: document.getElementById('renameInput'),
                confirmRename: document.getElementById('confirmRename'),
                cancelRename: document.getElementById('cancelRename'),
                
                settingsModal: document.getElementById('settingsModal'),
                settingsBtn: document.getElementById('settings-btn'),
                closeSettings: document.getElementById('closeSettings'),
                themeToggle: document.getElementById('theme-toggle'),
                autoMemoryToggle: document.getElementById('auto-memory-toggle-input'),
                globalProModeToggle: document.getElementById('global-pro-mode-toggle-input'),
                
                mainResizer: document.getElementById('main-resizer'),
                rightPanelResizer: document.getElementById('right-panel-resizer'),
                
                addMemoryBtn: document.getElementById('addMemoryBtn'),
                memorySearch: document.getElementById('memorySearch'),
                mainTitle: document.getElementById('main-title')
            };
            
            let attachedFile = null;
            let confirmCallback = null;
            let renameCallback = null;

            // Funções de persistência
            const saveState = () => {
                const stateToSave = { ...appState, proModeToken: null };
                localStorage.setItem('phoenixChatState_v13', JSON.stringify(stateToSave));
            };

            const loadState = () => {
                const savedState = localStorage.getItem('phoenixChatState_v13');
                if (savedState) {
                    const parsedState = JSON.parse(savedState);
                    parsedState.settings = { ...appState.settings, ...parsedState.settings };
                    appState = { ...appState, ...parsedState };
                }
                if (Object.keys(appState.chats).length === 0) {
                    createNewChat(false);
                } else {
                    if (!appState.activeChatId || !appState.chats[appState.activeChatId]) {
                        appState.activeChatId = Object.keys(appState.chats).sort((a,b) => b.split('-')[1] - a.split('-')[1])[0];
                    }
                    renderChatList();
                    loadChat(appState.activeChatId);
                }
                applySettings();
            };
            
            // Funções de gestão de chats
            const createNewChat = (save = true) => {
                const newChatId = `chat-${Date.now()}`;
                appState.chats[newChatId] = { 
                    id: newChatId, 
                    name: "Novo Chat", 
                    history: [], 
                    memories: [], 
                    isAutoMemory: appState.settings.autoMemory, 
                    canvasContent: '' 
                };
                if (save) { 
                    switchChat(newChatId); 
                } else {
                    appState.activeChatId = newChatId;
                    renderChatList();
                    loadChat(newChatId);
                }
            };

            const switchChat = (chatId) => {
                if (!appState.chats[chatId] || appState.activeChatId === chatId) return;
                appState.activeChatId = chatId;
                saveState();
                renderChatList();
                loadChat(chatId);
            };

            const loadChat = (chatId) => {
                const chat = appState.chats[chatId];
                if (!chat) {
                    if(Object.keys(appState.chats).length > 0) {
                        const latestChatId = Object.keys(appState.chats).sort((a,b) => b.split('-')[1] - a.split('-')[1])[0];
                        switchChat(latestChatId);
                    } else { 
                        createNewChat(); 
                    }
                    return;
                }

                elements.chatMessages.innerHTML = '';
                if (chat.history && chat.history.length > 0) {
                    elements.chatPlaceholder.classList.add('panel-hidden');
                    chat.history.forEach(msg => appendMessage(msg.text, msg.sender, msg.isPro, msg.usedContext, false));
                } else {
                    chat.history = [];
                    elements.chatPlaceholder.classList.remove('panel-hidden');
                }
                elements.autoMemoryToggle.checked = chat.isAutoMemory;
                renderMemories();
                renderCanvas(chat.canvasContent, false);
                setProUI(appState.settings.isProMode && appState.settings.proModeToken);
                clearAttachment();
            };

            const deleteChat = (chatId) => {
                if (Object.keys(appState.chats).length <= 1) { 
                    showNotification("Não é possível apagar o único chat existente."); 
                    return; 
                }
                delete appState.chats[chatId];
                if (appState.activeChatId === chatId) { 
                    appState.activeChatId = null; 
                }
                saveState(); 
                loadState();
            };

            const renameChat = (chatId, newName) => {
                if (appState.chats[chatId] && newName) {
                    appState.chats[chatId].name = newName;
                    saveState();
                    renderChatList();
                }
            };
            
            // Funções de renderização
            const renderChatList = () => {
                elements.chatListContainer.innerHTML = '';
                Object.values(appState.chats).sort((a,b) => b.id.split('-')[1] - a.id.split('-')[1]).forEach(chat => {
                    const isActive = chat.id === appState.activeChatId;
                    const item = document.createElement('div');
                    item.className = `chat-list-item p-2 my-1 rounded-md cursor-pointer hover:bg-[var(--bg-tertiary)] flex justify-between items-center group ${isActive ? 'active' : ''}`;
                    item.innerHTML = `
                        <span class="flex-grow truncate" title="${chat.name}">${chat.name}</span> 
                        <div class="flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity flex items-center">
                            <button class="rename-chat-btn p-1 hover:text-blue-400" title="Renomear">&#9998;</button>
                            <button class="delete-chat-btn p-1 hover:text-red-400 text-lg" title="Apagar">&times;</button>
                        </div>
                    `;
                    item.addEventListener('click', (e) => { 
                        if (!e.target.closest('button')) switchChat(chat.id); 
                    });
                    item.querySelector('.rename-chat-btn').addEventListener('click', () => {
                        showRenameModal(chat.id, chat.name);
                    });
                    item.querySelector('.delete-chat-btn').addEventListener('click', () => { 
                        showConfirmationModal(`Tem certeza que deseja apagar o chat "${chat.name}"?`, () => deleteChat(chat.id)); 
                    });
                    elements.chatListContainer.appendChild(item);
                });
            };

            const appendMessage = (text, sender, proResponse = false, usedContext = [], shouldSave = true) => {
                const chat = appState.chats[appState.activeChatId];
                if (!chat) return;

                elements.chatPlaceholder.classList.add('panel-hidden');
                
                // Sanitização com DOMPurify
                const contentHTML = sender === 'user' 
                    ? DOMPurify.sanitize(text.replace(/</g, "&lt;").replace(/>/g, "&gt;")) 
                    : DOMPurify.sanitize(marked.parse(text));
                
                const messageWrapper = document.createElement('div');
                messageWrapper.className = 'chat-message';
                
                let bubbleClass = 'chat-bubble-ai';
                if (sender === 'user') { 
                    bubbleClass = 'chat-bubble-user'; 
                } else if (proResponse) { 
                    bubbleClass = 'chat-bubble-ai-pro'; 
                }

                const alignment = sender === 'user' ? 'items-end' : 'items-start';
                const order = sender === 'user' ? 'order-2 items-end' : 'order-2 items-start';
                const avatar = sender === 'user' 
                    ? `<img src="https://placehold.co/40x40/3B82F6/FFFFFF?text=Vc" alt="User" class="w-8 h-8 rounded-full order-2">` 
                    : `<img src="https://placehold.co/40x40/5F6368/FFFFFF?text=IA" alt="AI" class="w-8 h-8 rounded-full order-1">`;
                
                const saveButtonHTML = (sender === 'ai' && text.trim()) 
                    ? `<button class="save-memory-btn mt-2 text-xs bg-green-600 hover:bg-green-700 text-white font-semibold py-1 px-3 rounded-full">Salvar</button>` 
                    : '';
                const contextHTML = (usedContext && usedContext.length > 0 && sender === 'ai') 
                    ? `<div class="text-xs text-[var(--text-secondary)] mt-2 border-t border-[var(--border-color)] pt-1">Contexto usado: ${usedContext.join(', ')}</div>` 
                    : '';
                
                messageWrapper.innerHTML = `
                    <div class="flex ${alignment}">
                        <div class="flex flex-col space-y-2 text-md max-w-3xl mx-2 ${order}">
                            <div>
                                <div class="px-4 py-2 rounded-lg inline-block ${sender === 'user' ? 'rounded-br-none' : 'rounded-bl-none'} ${bubbleClass}">
                                    <div class="markdown-content">${contentHTML}</div>
                                    ${contextHTML}
                                </div>
                                ${saveButtonHTML}
                            </div>
                        </div>
                        ${avatar}
                    </div>`;
                
                elements.chatMessages.appendChild(messageWrapper);
                elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;

                if (sender === 'ai' && text.trim()) {
                    const saveBtn = messageWrapper.querySelector('.save-memory-btn');
                    if (saveBtn) {
                        saveBtn.addEventListener('click', () => openMemoryModal(text));
                    }
                }

                if (shouldSave) {
                    chat.history.push({ text, sender, isPro: proResponse, usedContext });
                    if (chat.history.length === 1 && sender === 'user') {
                        const newName = text.substring(0, 25) + (text.length > 25 ? '...' : '');
                        renameChat(chat.id, newName);
                    }
                    saveState();
                }
            };

            const renderCanvas = (content, shouldSave = true) => {
                const chat = appState.chats[appState.activeChatId];
                if(!chat) return;
                
                // Sanitização com DOMPurify
                const parsedContent = content 
                    ? DOMPurify.sanitize(marked.parse(content)) 
                    : '<p class="text-center text-gray-500">O Canvas está vazio.</p>';
                elements.canvasContent.innerHTML = parsedContent;
                
                if (shouldSave) {
                    chat.canvasContent = content;
                    saveState();
                }
            };

            const renderMemories = () => {
                const chat = appState.chats[appState.activeChatId];
                if (!chat || !chat.memories) {
                    elements.memoryContainer.innerHTML = `<div class="p-4 text-center text-gray-500 text-sm">Nenhuma memória salva para este chat.</div>`;
                    return;
                }

                elements.memoryContainer.innerHTML = '';
                const searchTerm = elements.memorySearch.value.toLowerCase();
                
                const memoriesToRender = chat.memories;
                const filteredMemories = memoriesToRender.filter(mem => mem.text.toLowerCase().includes(searchTerm));

                const groupedByTopic = filteredMemories.reduce((acc, mem) => {
                    (mem.topics || []).forEach(topic => {
                        if (!acc[topic]) acc[topic] = [];
                        acc[topic].push(mem);
                    });
                    return acc;
                }, {});

                const sortedTopics = Object.keys(groupedByTopic).sort();

                if (sortedTopics.length === 0) {
                    elements.memoryContainer.innerHTML = `<div class="p-4 text-center text-gray-500 text-sm">Nenhuma memória encontrada.</div>`;
                    return;
                }

                sortedTopics.forEach(topic => {
                    const details = document.createElement('details');
                    details.className = 'p-2';
                    details.open = searchTerm.length > 0;

                    const summary = document.createElement('summary');
                    summary.className = 'font-bold text-lg cursor-pointer p-2 bg-gray-700 rounded-lg flex justify-between items-center';
                    
                    const topicMemories = groupedByTopic[topic];
                    const totalChars = topicMemories.reduce((sum, mem) => sum + mem.text.length, 0);
                    let warningHTML = (totalChars > 5000) 
                        ? `<span class="text-yellow-400" title="Tópico grande. Considere dividi-lo.">⚠️</span>` 
                        : '';
                    summary.innerHTML = `<span>${topic.charAt(0).toUpperCase() + topic.slice(1)}</span> <div class="flex items-center space-x-2">${warningHTML}<button class="delete-topic-btn p-1 hover:text-red-400 text-xs" title="Apagar Tópico">&times;</button></div>`;
                    
                    const topicContent = document.createElement('div');
                    topicContent.className = 'pl-4 pt-2';

                    topicMemories.forEach(mem => {
                        const memEl = document.createElement('div');
                        memEl.className = 'p-3 mb-2 bg-gray-800 border-l-4 border-yellow-500 rounded-r-lg shadow-sm';
                        memEl.innerHTML = `<p class="text-sm text-gray-300">${mem.text}</p><button class="delete-memory-btn mt-2 text-xs text-red-500 hover:text-red-400 font-semibold" data-id="${mem.id}">Excluir</button>`;
                        topicContent.appendChild(memEl);
                    });
                    
                    details.appendChild(summary);
                    details.appendChild(topicContent);
                    elements.memoryContainer.appendChild(details);

                    summary.querySelector('.delete-topic-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        showConfirmationModal(`Tem certeza que deseja apagar o tópico "${topic}" e todas as suas memórias?`, () => deleteTopic(topic));
                    });
                });

                // Event listeners para deletar memórias individuais
                elements.memoryContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('delete-memory-btn')) {
                        const memoryId = e.target.getAttribute('data-id');
                        showConfirmationModal('Tem certeza que deseja excluir esta memória?', () => deleteMemory(memoryId));
                    }
                });
            };
            
            const clearAttachment = () => {
                attachedFile = null;
                elements.attachmentPreview.innerHTML = '';
                elements.attachmentPreview.classList.add('hidden');
                elements.fileInput.value = '';
            };

            const showLoadingIndicator = (show = true) => {
                const existing = document.getElementById('loading-indicator');
                if (existing) existing.remove();
                if (show) {
                    const loadingHTML = `<div id="loading-indicator" class="chat-message"><div class="flex items-start"><div class="flex flex-col space-y-2 text-md max-w-lg mx-2 order-2 items-start"><div><span class="px-4 py-2 rounded-lg inline-block rounded-bl-none chat-bubble-ai">Pensando...</span></div></div><img src="https://placehold.co/40x40/5F6368/FFFFFF?text=IA" alt="AI profile" class="w-8 h-8 rounded-full order-1"></div></div>`;
                    elements.chatMessages.innerHTML += loadingHTML;
                    elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
                }
            };
            
            // Função de envio de mensagem
            const handleSend = async () => {
                const chat = appState.chats[appState.activeChatId];
                if (!chat) return;

                const query = elements.userInput.value.trim();
                if (!query && !attachedFile) return;

                appendMessage(query, 'user');
                elements.userInput.value = '';
                elements.userInput.style.height = 'auto';

                const imagePayload = attachedFile ? {
                    mimeType: attachedFile.type,
                    data: attachedFile.data
                } : null;
                
                clearAttachment();
                showLoadingIndicator();

                try {
                    const payload = { 
                        action: 'chat',
                        prompt: query, 
                        isPro: appState.settings.isProMode, 
                        proToken: appState.settings.proModeToken,
                        isAutoMemory: chat.isAutoMemory,
                        memories: chat.memories,
                        image: imagePayload
                    };
                    
                    const response = await fetch('/api/gemini', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    showLoadingIndicator(false);
                    if (!response.ok) {
                        const errorData = await response.json();
                        if (response.status === 401) { 
                            setProUI(false); 
                            showNotification("Senha do Modo Pro incorreta."); 
                        }
                        throw new Error(errorData.error || 'Falha na resposta do backend');
                    }

                    const result = await response.json();
                    
                    appendMessage(result.aiResponse, 'ai', appState.settings.isProMode, result.usedContext);
                    renderCanvas(result.aiResponse);

                    if (chat.isAutoMemory && result.newMemory) {
                        chat.memories.push(result.newMemory);
                        saveState();
                        renderMemories();
                    }
                } catch (error) {
                    showLoadingIndicator(false);
                    appendMessage(`**Erro:** ${error.message}`, 'ai');
                }
            };
            
            // Funções de UI
            const switchView = (view) => {
                appState.activeRightPanelView = view;
                const isMemory = view === 'memory';
                elements.memoryPanel.classList.toggle('hidden', !isMemory);
                elements.memoryPanel.classList.toggle('flex', isMemory);
                elements.canvasPanel.classList.toggle('hidden', isMemory);
                elements.canvasPanel.classList.toggle('flex', !isMemory);
                elements.viewMemoryBtn.classList.toggle('active', isMemory);
                elements.viewCanvasBtn.classList.toggle('active', !isMemory);
                saveState();
            };
            
            const showConfirmationModal = (message, onConfirm) => {
                elements.confirmMessage.textContent = message;
                confirmCallback = onConfirm;
                elements.confirmModal.classList.remove('hidden');
            };

            const showNotification = (message) => {
                elements.notificationMessage.textContent = message;
                elements.notificationModal.classList.remove('hidden');
            };
            
            const openMemoryModal = (rawText = null) => {
                elements.memoryText.value = rawText || '';
                elements.memoryTopics.value = '';
                elements.memoryModal.classList.remove('hidden');
                elements.memoryText.focus();
            };

            const saveMemory = () => {
                const chat = appState.chats[appState.activeChatId];
                if (!chat) return;
                const text = elements.memoryText.value.trim();
                const topics = elements.memoryTopics.value.split(',').map(t => t.trim().toLowerCase()).filter(Boolean);
                if (!text || topics.length === 0) { 
                    alert('Texto e tópico são obrigatórios.'); 
                    return; 
                }
                if (!chat.memories) chat.memories = [];
                chat.memories.push({ id: `mem-${Date.now()}`, text, topics });
                saveState();
                renderMemories();
                elements.memoryModal.classList.add('hidden');
            };
            
            const deleteMemory = (memoryId) => {
                const chat = appState.chats[appState.activeChatId];
                if (!chat || !chat.memories) return;
                chat.memories = chat.memories.filter(mem => mem.id !== memoryId);
                saveState();
                renderMemories();
            };

            const deleteTopic = (topicName) => {
                const chat = appState.chats[appState.activeChatId];
                if (!chat || !chat.memories) return;
                chat.memories.forEach(mem => { 
                    mem.topics = mem.topics.filter(t => t !== topicName); 
                });
                chat.memories = chat.memories.filter(mem => mem.topics.length > 0);
                saveState();
                renderMemories();
            };

            const setProUI = (active) => {
                appState.settings.isProMode = active;
                elements.mainTitle.textContent = active ? "Phoenix Chat (PRO)" : "Phoenix Chat";
                const svg = elements.proModeBtn.querySelector('svg');
                if (active) { 
                    svg.classList.add('text-yellow-400'); 
                } else { 
                    svg.classList.remove('text-yellow-400'); 
                    appState.settings.proModeToken = null; 
                }
                saveState();
            };

            const verifyPassword = async () => {
                const password = elements.proPasswordInput.value;
                if (!password) return;
                try {
                    const response = await fetch('/api/gemini', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'verifyPassword', token: password })
                    });
                    const result = await response.json();
                    elements.passwordModal.classList.add('hidden');
                    if (result.success) {
                        appState.settings.proModeToken = password;
                        setProUI(true);
                        showNotification("Modo Pro ativado com sucesso!");
                    } else {
                        setProUI(false);
                        showNotification("Senha incorreta.");
                    }
                } catch (e) {
                    elements.passwordModal.classList.add('hidden');
                    showNotification("Erro ao verificar a senha.");
                }
            };
            
            const applySettings = () => {
                // Tema
                if(appState.settings.theme === 'dark'){
                    elements.body.classList.add('dark');
                    elements.themeToggle.checked = true;
                } else {
                    elements.body.classList.remove('dark');
                    elements.themeToggle.checked = false;
                }
                // Pro Mode Global
                elements.globalProModeToggle.checked = appState.settings.globalProMode;
                if(appState.settings.globalProMode){
                    setProUI(true);
                }
                // Auto Memory
                elements.autoMemoryToggle.checked = appState.settings.autoMemory;
                
                // Right panel view
                switchView(appState.activeRightPanelView || 'memory');
            };

            const showRenameModal = (chatId, currentName) => {
                elements.renameInput.value = currentName;
                renameCallback = (newName) => renameChat(chatId, newName);
                elements.renameModal.classList.remove('hidden');
                elements.renameInput.focus();
            };

            // Event Listeners
            elements.newChatBtn.addEventListener('click', () => createNewChat());
            elements.sendButton.addEventListener('click', handleSend);
            elements.userInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSend();
                }
            });

            // Auto-resize textarea
            elements.userInput.addEventListener('input', () => {
                elements.userInput.style.height = 'auto';
                elements.userInput.style.height = elements.userInput.scrollHeight + 'px';
            });

            // Pro Mode
            elements.proModeBtn.addEventListener('click', () => {
                if (appState.settings.isProMode) {
                    setProUI(false);
                } else {
                    elements.passwordModal.classList.remove('hidden');
                    elements.proPasswordInput.focus();
                }
            });

            elements.confirmPassword.addEventListener('click', verifyPassword);
            elements.cancelPassword.addEventListener('click', () => {
                elements.passwordModal.classList.add('hidden');
                elements.proPasswordInput.value = '';
            });

            // Modals
            elements.closeNotification.addEventListener('click', () => {
                elements.notificationModal.classList.add('hidden');
            });

            elements.confirmSave.addEventListener('click', saveMemory);
            elements.cancelSave.addEventListener('click', () => {
                elements.memoryModal.classList.add('hidden');
            });

            elements.doConfirm.addEventListener('click', () => {
                if (confirmCallback) confirmCallback();
                elements.confirmModal.classList.add('hidden');
                confirmCallback = null;
            });
            elements.cancelConfirm.addEventListener('click', () => {
                elements.confirmModal.classList.add('hidden');
                confirmCallback = null;
            });

            elements.confirmRename.addEventListener('click', () => {
                const newName = elements.renameInput.value.trim();
                if (newName && renameCallback) {
                    renameCallback(newName);
                }
                elements.renameModal.classList.add('hidden');
                renameCallback = null;
            });
            elements.cancelRename.addEventListener('click', () => {
                elements.renameModal.classList.add('hidden');
                renameCallback = null;
            });

            // Settings
            elements.settingsBtn.addEventListener('click', () => {
                elements.settingsModal.classList.remove('hidden');
            });
            elements.closeSettings.addEventListener('click', () => {
                elements.settingsModal.classList.add('hidden');
            });

            elements.themeToggle.addEventListener('change', () => {
                appState.settings.theme = elements.themeToggle.checked ? 'dark' : 'light';
                applySettings();
                saveState();
            });

            elements.autoMemoryToggle.addEventListener('change', () => {
                appState.settings.autoMemory = elements.autoMemoryToggle.checked;
                const chat = appState.chats[appState.activeChatId];
                if (chat) {
                    chat.isAutoMemory = appState.settings.autoMemory;
                }
                saveState();
            });

            elements.globalProModeToggle.addEventListener('change', () => {
                appState.settings.globalProMode = elements.globalProModeToggle.checked;
                if (appState.settings.globalProMode) {
                    setProUI(true);
                } else {
                    setProUI(false);
                }
                saveState();
            });

            // Right panel
            elements.viewMemoryBtn.addEventListener('click', () => switchView('memory'));
            elements.viewCanvasBtn.addEventListener('click', () => switchView('canvas'));
            elements.closeRightPanelBtn.addEventListener('click', () => {
                elements.rightPanelContainer.classList.add('hidden');
                elements.rightPanelResizer.classList.add('panel-hidden');
            });

            // Memory
            elements.addMemoryBtn.addEventListener('click', () => openMemoryModal());
            elements.memorySearch.addEventListener('input', renderMemories);

            // File attachment
            elements.attachFileBtn.addEventListener('click', () => {
                elements.fileInput.click();
            });

            elements.fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const base64Data = e.target.result.split(',')[1];
                        attachedFile = {
                            type: file.type,
                            data: base64Data
                        };
                        
                        elements.attachmentPreview.innerHTML = `
                            <div class="flex items-center space-x-2">
                                <img src="${e.target.result}" alt="Preview" class="w-16 h-16 object-cover rounded">
                                <span class="text-sm">${file.name}</span>
                                <button id="removeAttachment" class="text-red-500 hover:text-red-700">&times;</button>
                            </div>
                        `;
                        elements.attachmentPreview.classList.remove('hidden');
                        
                        document.getElementById('removeAttachment').addEventListener('click', clearAttachment);
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Sidebar collapse
            elements.collapseChatListBtn.addEventListener('click', () => {
                elements.leftSidebar.classList.add('panel-hidden');
                elements.expandChatListBtn.classList.remove('panel-hidden');
            });

            elements.expandChatListBtn.addEventListener('click', () => {
                elements.leftSidebar.classList.remove('panel-hidden');
                elements.expandChatListBtn.classList.add('panel-hidden');
            });

            // Inicialização
            loadState();
        });
    </script>
</body>
</html>
