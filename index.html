<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot com Memória v7 (Seguro)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #131314; --bg-secondary: #1e1f20; --bg-tertiary: #35363a;
            --text-primary: #e8eaed; --text-secondary: #9aa0a6;
            --accent-blue: #8ab4f8; --accent-pro: #fbbc04;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-primary); }
        .chat-bubble-user { background-color: #3b82f6; color: white; }
        .chat-bubble-ai { background-color: var(--bg-tertiary); color: var(--text-primary); }
        .chat-bubble-ai-pro { background-color: #4a3c1a; border: 1px solid var(--accent-pro); color: #fef08a; }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 { font-weight: bold; margin-top: 1rem; margin-bottom: 0.5rem; border-bottom: 1px solid #4a4a4e; padding-bottom: 0.25rem;}
        .markdown-content p { margin-bottom: 0.75rem; }
        .markdown-content ul, .markdown-content ol { margin-left: 1.5rem; margin-bottom: 0.75rem; }
        .markdown-content code { background-color: var(--bg-primary); padding: 0.2em 0.4em; border-radius: 3px; font-family: 'Courier New', Courier, monospace; }
        .markdown-content pre { background-color: var(--bg-primary); padding: 1rem; border-radius: 8px; overflow-x: auto; }
        .markdown-content a { color: var(--accent-blue); text-decoration: underline; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: var(--bg-primary); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4a4a4e; border-radius: 4px; }
        .modal-overlay { transition: opacity 0.3s ease; }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        .toggle-bg:after { content: ''; position: absolute; top: 2px; left: 2px; background: white; border-radius: 50%; height: 1.25rem; width: 1.25rem; transition: 0.2s; }
        input:checked + .toggle-bg:after { transform: translateX(100%); }
        input:checked + .toggle-bg { background-color: #34d399; }
    </style>
</head>
<body class="flex flex-col md:flex-row h-screen antialiased text-gray-200">
    <!-- Main Chat Area -->
    <div class="flex flex-col flex-auto h-full p-4 md:p-6">
        <div class="flex flex-col flex-auto flex-shrink-0 rounded-2xl bg-[var(--bg-secondary)] h-full p-4 shadow-2xl">
            <div class="flex flex-col h-full overflow-hidden">
                <div class="text-center py-2 border-b border-gray-700">
                    <div class="flex justify-center items-center space-x-2">
                        <h1 id="main-title" class="text-2xl font-bold text-gray-200">Chatbot com Memória</h1>
                        <button id="proModeBtn" title="Ativar Modo Pro"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500 hover:text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg></button>
                    </div>
                </div>
                <div id="chat-container" class="flex flex-col h-full overflow-y-auto mb-4 custom-scrollbar">
                    <div class="flex flex-col space-y-4 p-3">
                         <div class="chat-message"><div class="flex items-start"><div class="flex flex-col space-y-2 text-md max-w-lg mx-2 order-2 items-start"><div><div class="px-4 py-2 rounded-lg inline-block rounded-bl-none chat-bubble-ai"><div class="markdown-content"><p>Olá! Esta é a v7.1 (corrigida). O erro da interface foi consertado.</p></div></div></div></div><img src="https://placehold.co/40x40/5F6368/FFFFFF?text=IA" alt="AI profile" class="w-8 h-8 rounded-full order-1"></div></div>
                    </div>
                </div>
                <div class="flex flex-row items-center h-16 rounded-xl bg-[var(--bg-secondary)] w-full px-4">
                    <div class="flex-grow"><div class="relative w-full"><input type="text" id="userInput" class="flex w-full border border-gray-700 bg-[var(--bg-tertiary)] rounded-xl focus:outline-none focus:border-indigo-500 pl-4 h-10 text-gray-200" placeholder="Digite sua mensagem..."></div></div>
                    <div class="ml-4"><button id="sendButton" class="flex items-center justify-center bg-indigo-600 hover:bg-indigo-700 rounded-xl text-white px-4 py-2 flex-shrink-0"><span>Enviar</span></button></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Memory Area -->
    <div class="flex flex-col w-full md:w-1/3 h-full p-4 md:p-6">
        <div class="flex flex-col flex-auto flex-shrink-0 rounded-2xl bg-[var(--bg-secondary)] h-full p-4 shadow-2xl">
             <div class="text-center py-2 border-b border-gray-700"><h2 class="text-xl font-bold text-gray-200">Base de Memória</h2></div>
            <div class="p-2 flex space-x-2 items-center justify-between"><input type="text" id="memorySearch" class="w-full border border-gray-700 bg-[var(--bg-tertiary)] rounded-lg px-3 py-2 text-sm text-gray-200" placeholder="Buscar em todas as memórias..."><button id="addMemoryBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-lg text-sm">Add</button></div>
            <div class="p-2 flex items-center justify-between border-b border-gray-700"><span class="text-sm font-medium text-gray-300">Memória Automática</span><label for="auto-memory-toggle" class="flex items-center cursor-pointer"><div class="relative"><input type="checkbox" id="auto-memory-toggle" class="sr-only"><div class="block bg-gray-600 w-10 h-6 rounded-full toggle-bg"></div></div></label></div>
            <div id="memory-container" class="flex flex-col h-full overflow-y-auto custom-scrollbar"></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="memoryModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden"><div class="bg-[#2d2d30] p-6 rounded-lg shadow-xl w-1/3 text-gray-200"><h3 class="text-lg font-bold mb-4">Salvar Memória Manual</h3><textarea id="memoryText" class="w-full border border-gray-600 bg-[var(--bg-tertiary)] rounded-lg p-2 h-32 mb-4" placeholder="Texto da memória..."></textarea><input type="text" id="memoryTopics" class="w-full border border-gray-600 bg-[var(--bg-tertiary)] rounded-lg p-2 mb-4" placeholder="Tópicos (separados por vírgula)..."><div class="flex justify-end space-x-2"><button id="cancelSave" class="px-4 py-2 bg-gray-600 rounded-lg">Cancelar</button><button id="confirmSave" class="px-4 py-2 bg-green-600 text-white rounded-lg">Salvar</button></div></div></div>
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden"><div class="bg-[#2d2d30] p-6 rounded-lg shadow-xl w-1/3 text-gray-200"><h3 class="text-lg font-bold mb-4">Confirmar Ação</h3><p id="confirmMessage" class="mb-4">Você tem certeza?</p><div class="flex justify-end space-x-2"><button id="cancelConfirm" class="px-4 py-2 bg-gray-600 rounded-lg">Cancelar</button><button id="doConfirm" class="px-4 py-2 bg-red-600 text-white rounded-lg">Confirmar</button></div></div></div>
    <div id="passwordModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden"><div class="bg-[#2d2d30] p-6 rounded-lg shadow-xl w-1/3 text-gray-200"><h3 class="text-lg font-bold mb-4">Ativar Modo Pro</h3><p class="text-sm text-gray-400 mb-4">Digite a senha para usar o modelo Pro.</p><input type="password" id="proPasswordInput" class="w-full border border-gray-600 bg-[var(--bg-tertiary)] rounded-lg p-2 mb-4" placeholder="Senha..."><div class="flex justify-end space-x-2"><button id="cancelPassword" class="px-4 py-2 bg-gray-600 rounded-lg">Cancelar</button><button id="confirmPassword" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">Ativar</button></div></div></div>

    <script>
        // ESTE ARQUIVO NÃO CONTÉM MAIS NENHUMA SENHA.
        
        // Seletores de elementos da UI
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const proModeBtn = document.getElementById('proModeBtn');
        const mainTitle = document.getElementById('main-title');
        const autoMemoryToggle = document.getElementById('auto-memory-toggle');
        const chatContainer = document.getElementById('chat-container');
        const memoryContainer = document.getElementById('memory-container');
        const memorySearch = document.getElementById('memorySearch');
        const addMemoryBtn = document.getElementById('addMemoryBtn');
        const memoryModal = document.getElementById('memoryModal');
        const memoryText = document.getElementById('memoryText');
        const memoryTopics = document.getElementById('memoryTopics');
        const cancelSave = document.getElementById('cancelSave');
        const confirmSave = document.getElementById('confirmSave');
        const confirmModal = document.getElementById('confirmModal');
        const confirmMessage = document.getElementById('confirmMessage');
        const cancelConfirm = document.getElementById('cancelConfirm');
        const doConfirm = document.getElementById('doConfirm');
        const passwordModal = document.getElementById('passwordModal');
        const proPasswordInput = document.getElementById('proPasswordInput');
        const cancelPassword = document.getElementById('cancelPassword');
        const confirmPassword = document.getElementById('confirmPassword');

        // Estado da aplicação
        let memories = JSON.parse(localStorage.getItem('rag_memories_v7')) || [];
        let isProMode = false;
        let proModeToken = null;
        let isAutoMemory = localStorage.getItem('auto_memory_v7') === 'true';
        autoMemoryToggle.checked = isAutoMemory;
        let confirmCallback = null;

        // Função de envio principal
        const handleSend = async () => {
            const query = userInput.value.trim();
            if (!query) return;

            appendMessage(query, 'user');
            userInput.value = '';
            showLoadingIndicator();

            try {
                const payload = { 
                    prompt: query, 
                    isPro: isProMode, 
                    proToken: proModeToken,
                    isAutoMemory: isAutoMemory,
                    memories: memories
                };
                
                const response = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    if (response.status === 401) {
                        deactivateProMode(true);
                    }
                    throw new Error(errorData.error || 'Falha na resposta do backend');
                }

                const result = await response.json();
                showLoadingIndicator(false);
                appendMessage(result.aiResponse, 'ai', isProMode, result.usedContext);

                if (isAutoMemory && result.newMemory) {
                    memories.push(result.newMemory);
                    localStorage.setItem('rag_memories_v7', JSON.stringify(memories));
                    renderMemories();
                }

            } catch (error) {
                showLoadingIndicator(false);
                appendMessage(`**Erro:** ${error.message}`, 'ai');
            }
        };

        // --- CÓDIGO CORRIGIDO - APENAS UMA FUNÇÃO appendMessage ---
        const appendMessage = (text, sender, proResponse = false, usedContext = []) => {
            const messageId = `msg-${Date.now()}`;
            const isUser = sender === 'user';
            
            let bubbleClass = 'chat-bubble-ai';
            if (isUser) { bubbleClass = 'chat-bubble-user'; } 
            else if (proResponse) { bubbleClass = 'chat-bubble-ai-pro'; }

            const contentHTML = isUser ? text.replace(/</g, "&lt;").replace(/>/g, "&gt;") : marked.parse(text);
            const alignment = isUser ? 'items-end' : 'items-start';
            const order = isUser ? 'order-2 items-end' : 'order-2 items-start';
            const avatar = isUser ? `<img src="https://placehold.co/40x40/3B82F6/FFFFFF?text=Vc" alt="User" class="w-8 h-8 rounded-full order-2">` : `<img src="https://placehold.co/40x40/5F6368/FFFFFF?text=IA" alt="AI" class="w-8 h-8 rounded-full order-1">`;
            
            // Lógica robusta para o botão de salvar, usando o ID da mensagem
            const saveButtonHTML = (isUser || !text.trim()) ? '' : `<button onclick="openMemoryModal('${messageId}')" class="mt-2 text-xs bg-green-600 hover:bg-green-700 text-white font-semibold py-1 px-3 rounded-full">Salvar</button>`;
            
            const contextHTML = (usedContext.length > 0 && !isUser) ? `<div class="text-xs text-gray-500 mt-2 border-t border-gray-700 pt-1">Contexto usado: ${usedContext.join(', ')}</div>` : '';
            
            const messageWrapper = document.createElement('div');
            messageWrapper.className = 'chat-message';
            messageWrapper.innerHTML = `<div class="flex ${alignment}"><div class="flex flex-col space-y-2 text-md max-w-lg mx-2 ${order}"><div><div id="${messageId}" class="px-4 py-2 rounded-lg inline-block ${isUser ? 'rounded-br-none' : 'rounded-bl-none'} ${bubbleClass}"><div class="markdown-content">${contentHTML}</div>${contextHTML}</div>${saveButtonHTML}</div></div>${avatar}</div>`;
            
            chatContainer.querySelector('.space-y-4').appendChild(messageWrapper);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        };

        window.openMemoryModal = (messageId, rawText = null) => {
            // Se um ID for passado, pega o texto original (não formatado)
            // Se rawText for passado (do botão de salvar), usa ele
            let textToSave = rawText;
            if (messageId) {
                 const el = document.getElementById(messageId);
                 if(el) textToSave = el.querySelector('.markdown-content').innerText;
            }
            memoryText.value = textToSave || '';
            memoryTopics.value = '';
            memoryModal.classList.remove('hidden');
            confirmSave.onclick = () => saveMemory();
        };

        // ... o resto do seu JS continua aqui ...
        const renderMemories = () => { memoryContainer.innerHTML = ''; const searchTerm = memorySearch.value.toLowerCase(); const filteredMemories = memories.filter(mem => mem.text.toLowerCase().includes(searchTerm)); const groupedByTopic = filteredMemories.reduce((acc, mem) => { mem.topics.forEach(topic => { if (!acc[topic]) acc[topic] = []; acc[topic].push(mem); }); return acc; }, {}); const sortedTopics = Object.keys(groupedByTopic).sort(); if (sortedTopics.length === 0) { memoryContainer.innerHTML = `<div class="p-4 text-center text-gray-500 text-sm">Nenhuma memória salva.</div>`; return; } sortedTopics.forEach(topic => { const details = document.createElement('details'); details.className = 'p-2'; details.open = searchTerm.length > 0; const summary = document.createElement('summary'); summary.className = 'font-bold text-lg cursor-pointer p-2 bg-gray-700 rounded-lg flex justify-between items-center'; const topicMemories = groupedByTopic[topic]; const totalChars = topicMemories.reduce((sum, mem) => sum + mem.text.length, 0); let warningHTML = (totalChars > 5000) ? `<span class="text-yellow-400" title="Tópico grande. Considere dividi-lo.">⚠️</span>` : ''; summary.innerHTML = `<span>${topic.charAt(0).toUpperCase() + topic.slice(1)}</span> <div class="flex items-center space-x-2">${warningHTML}<button onclick="event.stopPropagation(); showConfirmationModal('Tem certeza que deseja apagar o tópico \\'${topic}\\' e todas as suas memórias?', () => deleteTopic('${topic}'))" class="text-red-500 hover:text-red-400 text-xs">Apagar Tópico</button></div>`; const topicContent = document.createElement('div'); topicContent.className = 'pl-4 pt-2'; topicMemories.forEach(mem => { const memEl = document.createElement('div'); memEl.className = 'p-3 mb-2 bg-gray-800 border-l-4 border-yellow-500 rounded-r-lg shadow-sm'; memEl.innerHTML = `<p class="text-sm text-gray-300">${mem.text}</p><button onclick="showConfirmationModal('Tem certeza que deseja apagar esta memória?', () => deleteMemory('${mem.id}'))" class="mt-2 text-xs text-red-500 hover:text-red-400 font-semibold">Excluir</button>`; topicContent.appendChild(memEl); }); details.appendChild(summary); details.appendChild(topicContent); memoryContainer.appendChild(details); }); };
        const saveMemory = () => { const text = memoryText.value.trim(); const topics = memoryTopics.value.split(',').map(t => t.trim().toLowerCase()).filter(Boolean); if (!text || topics.length === 0) { alert('Texto e tópico são obrigatórios.'); return; } memories.push({ id: `mem-${Date.now()}`, text, topics }); localStorage.setItem('rag_memories_v7', JSON.stringify(memories)); renderMemories(); memoryModal.classList.add('hidden'); };
        window.deleteMemory = (memoryId) => { memories = memories.filter(mem => mem.id !== memoryId); localStorage.setItem('rag_memories_v7', JSON.stringify(memories)); renderMemories(); };
        window.deleteTopic = (topicName) => { memories = memories.filter(mem => !mem.topics.includes(topicName)); renderMemories(); memories.forEach(mem => { mem.topics = mem.topics.filter(t => t !== topicName); }); localStorage.setItem('rag_memories_v7', JSON.stringify(memories)); renderMemories(); };
        const showConfirmationModal = (message, onConfirm) => { confirmMessage.textContent = message; confirmCallback = onConfirm; confirmModal.classList.remove('hidden'); };
        const showLoadingIndicator = (show = true) => { const existing = document.getElementById('loading-indicator'); if(existing) existing.remove(); if(show){ const loadingHTML = `<div id="loading-indicator" class="chat-message"><div class="flex items-start"><div class="flex flex-col space-y-2 text-md max-w-lg mx-2 order-2 items-start"><div><span class="px-4 py-2 rounded-lg inline-block rounded-bl-none chat-bubble-ai">Pensando...</span></div></div><img src="https://placehold.co/40x40/5F6368/FFFFFF?text=IA" alt="AI profile" class="w-8 h-8 rounded-full order-1"></div></div>`; chatContainer.querySelector('.space-y-4').innerHTML += loadingHTML; chatContainer.scrollTop = chatContainer.scrollHeight; } };
        function activateProMode(password) { isProMode = true; proModeToken = password; mainTitle.textContent = "Chatbot com Memória (PRO)"; proModeBtn.querySelector('svg').classList.remove('text-gray-500'); proModeBtn.querySelector('svg').classList.add('text-yellow-400'); alert("Modo Pro ativado. A verificação da senha será feita na próxima mensagem."); passwordModal.classList.add('hidden'); proPasswordInput.value = ''; }
        function deactivateProMode(isError = false) { isProMode = false; proModeToken = null; mainTitle.textContent = "Chatbot com Memória"; proModeBtn.querySelector('svg').classList.remove('text-yellow-400'); proModeBtn.querySelector('svg').classList.add('text-gray-500'); if(!isError) alert("Modo Pro desativado."); }
        
        sendButton.addEventListener('click', handleSend);
        userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSend(); });
        memorySearch.addEventListener('input', renderMemories);
        addMemoryBtn.addEventListener('click', () => openMemoryModal());
        cancelSave.addEventListener('click', () => memoryModal.classList.add('hidden'));
        cancelPassword.addEventListener('click', () => { passwordModal.classList.add('hidden'); proPasswordInput.value = ''; });
        cancelConfirm.addEventListener('click', () => { confirmModal.classList.add('hidden'); confirmCallback = null; });
        doConfirm.addEventListener('click', () => { if (confirmCallback) confirmCallback(); confirmModal.classList.add('hidden'); confirmCallback = null; });
        autoMemoryToggle.addEventListener('change', (e) => { isAutoMemory = e.target.checked; localStorage.setItem('auto_memory_v7', isAutoMemory ? 'true' : 'false'); alert(`Memória automática ${isAutoMemory ? 'ativada' : 'desativada'}.`); });
        proModeBtn.addEventListener('click', () => { if (isProMode) { deactivateProMode(); } else { passwordModal.classList.remove('hidden'); proPasswordInput.focus(); } });
        confirmPassword.addEventListener('click', () => { const password = proPasswordInput.value; if (password) { activateProMode(password); } });
        proPasswordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { confirmPassword.click(); } });

        renderMemories();
    </script>
</body>
</html>
