<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phoenix Chat</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üî•</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@latest/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@latest/dist/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #ffffff; 
            --bg-secondary: #f8f9fa; 
            --bg-tertiary: #e9ecef;
            --text-primary: #212529; 
            --text-secondary: #495057;
            --border-color: #dee2e6; 
            --accent-pro: #fd7e14;
            --empty-state-bg: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --canvas-bg: #ffffff;
            --canvas-border: #e0e0e0;
            --chat-bubble-ai-bg: #e9ecef;
            --chat-bubble-ai-text: #212529;
            --chat-bubble-user-bg: #3b82f6;
            --chat-bubble-user-text: #ffffff;
            --chat-bubble-pro-bg: #fffbeb;
            --chat-bubble-pro-text: #92400e;
            --chat-bubble-pro-border: #fbbF04;
            --harmony-color-1: #667eea;
            --harmony-color-2: #764ba2;
        }
        
        .dark {
            --bg-primary: #131314; 
            --bg-secondary: #1e1f20; 
            --bg-tertiary: #35363a;
            --text-primary: #e8eaed; 
            --text-secondary: #9aa0a6;
            --border-color: #4a4a4e; 
            --accent-pro: #fbbc04;
            --empty-state-bg: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            --canvas-bg: #1a1a1a;
            --canvas-border: #333333;
            --chat-bubble-ai-bg: #35363a;
            --chat-bubble-ai-text: #e8eaed;
            --chat-bubble-user-bg: #3b82f6;
            --chat-bubble-user-text: #ffffff;
            --chat-bubble-pro-bg: #4a3c1a;
            --chat-bubble-pro-text: #fef08a;
            --chat-bubble-pro-border: #fbbc04;
            --harmony-color-1: #667eea;
            --harmony-color-2: #764ba2;
        }

        * { 
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, opacity 0.3s ease; 
        }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-primary); 
            color: var(--text-primary);
            overflow-y: auto;
        }
        
        #empty-state {
            background: var(--empty-state-bg);
            opacity: 1;
            transition: opacity 0.5s ease-in-out;
        }
        
        .chat-bubble-user { 
            background-color: var(--chat-bubble-user-bg); 
            color: var(--chat-bubble-user-text); 
        }
        
        .chat-bubble-ai { 
            background-color: var(--chat-bubble-ai-bg); 
            color: var(--chat-bubble-ai-text); 
        }
        
        .chat-bubble-ai-pro { 
            background-color: var(--chat-bubble-pro-bg); 
            border: 1px solid var(--chat-bubble-pro-border); 
            color: var(--chat-bubble-pro-text); 
        }
        
        .markdown-content h1, .markdown-content h2, .markdown-content h3 { 
            font-weight: bold; 
            margin-top: 1rem; 
            margin-bottom: 0.5rem; 
            border-bottom: 1px solid var(--border-color); 
            padding-bottom: 0.25rem;
        }
        
        .markdown-content p { 
            margin-bottom: 0.75rem; 
            line-height: 1.6; 
        }
        
        .markdown-content ul, .markdown-content ol { 
            margin-left: 1.5rem; 
            margin-bottom: 0.75rem; 
        }
        
        .markdown-content code:not(pre > code) { 
            background-color: var(--bg-secondary); 
            padding: 0.2em 0.4em; 
            border-radius: 3px; 
            font-family: 'Courier New', Courier, monospace; 
        }
        
        .markdown-content pre { 
            background-color: var(--bg-secondary); 
            padding: 1rem; 
            border-radius: 8px; 
            overflow-x: auto; 
            white-space: pre-wrap; 
            word-wrap: break-word;
        }
        
        .markdown-content a { 
            color: #8ab4f8; 
            text-decoration: underline; 
        }

        .custom-scrollbar::-webkit-scrollbar { 
            width: 6px; 
        }
        
        .custom-scrollbar::-webkit-scrollbar-track { 
            background: transparent; 
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb { 
            background: #5f6368; 
            border-radius: 3px; 
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { 
            background: #7a7a7a; 
        }
        
        .toggle-bg:after { 
            content: ''; 
            position: absolute; 
            top: 2px; 
            left: 2px; 
            background: white; 
            border-radius: 50%; 
            height: 1.25rem; 
            width: 1.25rem; 
            transition: 0.2s; 
        }
        
        input:checked + .toggle-bg:after { 
            transform: translateX(100%); 
        }
        
        input:checked + .toggle-bg { 
            background-color: #34d399; 
        }
        
        .resizer { 
            background-color: var(--border-color); 
            width: 4px; 
            cursor: col-resize; 
            z-index: 10; 
            opacity: 0.5; 
            transition: opacity 0.2s; 
        }
        
        .resizer:hover { 
            opacity: 1; 
        }
        
        .panel-hidden { 
            display: none !important; 
        }
        
        .chat-list-item.active { 
            background-color: var(--bg-tertiary); 
        }
        
        .view-btn.active { 
            background-color: var(--bg-tertiary); 
            color: var(--text-primary); 
        }
        
        .input-container { 
            max-height: 200px; 
        }
        
        .input-container textarea { 
            resize: none; 
            overflow: hidden; 
        }
        
        .input-container textarea.has-scroll { 
            overflow-y: auto; 
        }
        
        .input-container textarea::-webkit-scrollbar { 
            width: 4px; 
        }
        
        .input-container textarea::-webkit-scrollbar-track { 
            background: transparent; 
        }
        
        .input-container textarea::-webkit-scrollbar-thumb { 
            background: #5f6368; 
            border-radius: 2px; 
        }
        
        .canvas-mode #main-chat-panel { 
            width: 350px !important; 
            flex-shrink: 0; 
        }
        
        .canvas-mode #right-panel-container { 
            flex: 1 !important; 
            width: auto !important; 
            max-width: 60% !important; 
        }
        
        .right-panel-collapsed { 
            width: 0 !important; 
            min-width: 0 !important; 
            overflow: hidden; 
        }
        
        .expand-right-panel-btn { 
            position: fixed; 
            top: 50%; 
            right: 10px; 
            z-index: 30; 
            transform: translateY(-50%); 
        }
        
        .canvas-content { 
            max-height: 70vh; 
            overflow-y: auto; 
            background: var(--canvas-bg);
            border: 1px solid var(--canvas-border);
            border-radius: 8px;
        }
        
        .canvas-content pre { 
            position: relative; 
            margin: 0;
            background: var(--canvas-bg) !important;
        }
        
        .canvas-content .line-numbers { 
            position: absolute; 
            left: 0; 
            top: 0; 
            padding: 1rem 0.5rem; 
            background: rgba(0,0,0,0.1); 
            border-right: 1px solid var(--border-color); 
            font-family: 'Fira Code', 'Courier New', monospace; 
            font-size: 0.8em; 
            line-height: 1.5; 
            color: var(--text-secondary); 
            user-select: none;
        }
        
        .canvas-content .code-content { 
            padding-left: 3rem; 
            font-family: 'Fira Code', 'Courier New', monospace;
        }
        
        .memory-topic-header { 
            cursor: pointer; 
        }
        
        .memory-topic-header:hover .rename-topic-btn { 
            opacity: 1; 
        }
        
        .rename-topic-btn { 
            opacity: 0; 
            transition: opacity 0.2s; 
        }
        
        #right-panel-container {
            min-width: 384px; 
            max-width: 60%;
            transition: width 0.3s ease-in-out;
        }
        
        .canvas-resizer {
            position: absolute; 
            left: 0; 
            top: 0; 
            bottom: 0; 
            width: 4px;
            background-color: var(--border-color); 
            cursor: col-resize; 
            z-index: 20;
            opacity: 0.5; 
            transition: opacity 0.2s;
        }
        
        .canvas-resizer:hover { 
            opacity: 1; 
            background-color: #3b82f6; 
        }
        
        .canvas-resizing { 
            user-select: none; 
        }
        
        .canvas-toolbar {
            background: var(--bg-tertiary); 
            border-bottom: 1px solid var(--border-color);
            padding: 0.75rem; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            font-size: 0.875rem; 
            color: var(--text-secondary);
            border-radius: 8px 8px 0 0;
        }
        
        .canvas-toolbar .toolbar-left { 
            display: flex; 
            align-items: center; 
            gap: 1rem; 
        }
        
        .canvas-toolbar .toolbar-right { 
            display: flex; 
            align-items: center; 
            gap: 0.5rem; 
        }
        
        .canvas-toolbar button {
            padding: 0.5rem 0.75rem; 
            border-radius: 0.375rem;
            background: var(--bg-secondary); 
            border: 1px solid var(--border-color);
            color: var(--text-primary); 
            font-size: 0.75rem;
            cursor: pointer; 
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .canvas-toolbar button:hover { 
            background: var(--bg-primary); 
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .move-to-global-btn {
            background: #059669; 
            color: white; 
            border: none;
            padding: 0.125rem 0.5rem; 
            border-radius: 0.25rem;
            font-size: 0.75rem; 
            cursor: pointer;
            opacity: 0; 
            transition: opacity 0.2s;
        }
        
        .move-to-global-btn:hover { 
            background: #047857; 
        }
        
        .memory-item:hover .move-to-global-btn { 
            opacity: 1; 
        }

        .canvas-empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 300px;
            text-align: center;
            color: var(--text-secondary);
            background: var(--canvas-bg);
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            margin: 1rem;
        }

        .canvas-empty-state svg {
            width: 4rem;
            height: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .canvas-document {
            background: var(--canvas-bg);
            border: 1px solid var(--canvas-border);
            border-radius: 8px;
            margin: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .canvas-document-header {
            background: var(--bg-tertiary);
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .canvas-document-content {
            padding: 1.5rem;
            line-height: 1.6;
        }

        .empty-state-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            text-align: center;
            padding: 2rem;
        }

        .empty-state-container h1 {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 1rem;
            background: linear-gradient(45deg, var(--harmony-color-1), var(--harmony-color-2));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .empty-state-container p {
            font-size: 1.25rem;
            opacity: 0.8;
            margin-bottom: 2rem;
        }

        .empty-state-container button {
            background: linear-gradient(45deg, var(--harmony-color-1), var(--harmony-color-2));
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            font-size: 1.125rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .empty-state-container button:hover {
            transform: translateY(-2px);
        }

        .fade-out {
            opacity: 0;
            pointer-events: none;
        }

        .fade-in {
            opacity: 1;
        }
        
        .drag-over {
            border: 2px dashed var(--harmony-color-1) !important;
            background-color: rgba(102, 126, 234, 0.1) !important;
        }
        
        .dark .drag-over {
            background-color: rgba(102, 126, 234, 0.2) !important;
        }
    </style>
</head>
<body class="flex flex-col h-screen antialiased">
    
    <!-- Estado Vazio (sem chats) -->
    <div id="empty-state" class="empty-state panel-hidden">
        <div class="empty-state-container">
            <h1>Phoenix Chat</h1>
            <p>Bem-vindo ao seu assistente de IA pessoal</p>
            <button id="create-first-chat-btn">Criar Primeiro Chat</button>
        </div>
    </div>
    
    <!-- Interface Principal -->
    <div id="main-interface" class="flex flex-row flex-1 overflow-hidden opacity-0">
        <!-- Barra Lateral Esquerda -->
        <div id="left-sidebar" class="flex flex-col w-64 bg-[var(--bg-secondary)] flex-shrink-0">
            <div id="chat-list-panel" class="flex flex-col flex-grow p-2">
                <div class="flex items-center justify-between p-2 border-b border-[var(--border-color)]">
                    <h2 class="text-xl font-bold text-[var(--text-primary)]">Chats</h2>
                    <div class="flex items-center">
                        <button id="newChatBtn" class="p-2 rounded-md hover:bg-[var(--bg-tertiary)] text-[var(--text-secondary)]" title="Novo Chat">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        </button>
                        <button id="collapse-chat-list-btn" class="p-2 rounded-md hover:bg-[var(--bg-tertiary)] text-[var(--text-secondary)]" title="Recolher Chats">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path></svg>
                        </button>
                    </div>
                </div>
                <div id="chat-list-container" class="flex-grow overflow-y-auto custom-scrollbar">
                    <!-- Os chats ser√£o inseridos aqui pelo JS -->
                </div>
            </div>
            <div class="p-2 border-t border-[var(--border-color)]">
                <button id="settings-btn" class="w-full flex items-center p-2 rounded-md hover:bg-[var(--bg-tertiary)] text-[var(--text-secondary)]" title="Configura√ß√µes">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <span>Configura√ß√µes</span>
                </button>
            </div>
        </div>
        
        <!-- Bot√£o para reabrir a lista de chats -->
        <button id="expand-chat-list-btn" class="panel-hidden absolute top-2 left-2 z-20 p-2 bg-gray-700 rounded-md hover:bg-gray-600" title="Expandir Chats">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path></svg>
        </button>
        
        <!-- Puxador de redimensionamento -->
        <div id="main-resizer" class="resizer"></div>

        <!-- Container Principal -->
        <div id="main-container" class="flex flex-auto flex-row h-full">

            <!-- Chat Principal -->
            <div id="main-chat-panel" class="flex flex-col flex-auto h-full p-4 transition-all duration-300 ease-in-out">
                <div class="flex flex-col flex-auto flex-shrink-0 rounded-2xl bg-[var(--bg-secondary)] h-full p-4 shadow-2xl">
                    <div class="flex flex-col h-full overflow-hidden">
                        <div class="text-center py-2 border-b border-[var(--border-color)]">
                            <div class="flex justify-center items-center space-x-2">
                                <h1 id="main-title" class="text-2xl font-bold text-[var(--text-primary)]">Phoenix Chat</h1>
                                <button id="proModeBtn" title="Ativar Modo Pro" class="text-[var(--text-secondary)] hover:text-[var(--accent-pro)]">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div id="chat-container" class="flex flex-col flex-1 overflow-y-auto mb-4 custom-scrollbar">
                             <div id="chat-messages" class="flex flex-col space-y-4 p-3">
                                <div id="chat-placeholder" class="flex flex-col items-center justify-center h-full text-[var(--text-secondary)]">
                                    <svg class="w-24 h-24 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5-2.5-7S3 7 3 7a8 8 0 0110.657 10.657l3.414 3.414a2 2 0 01-2.828 2.828l-3.414-3.414zM4 4l16 16"/>
                                    </svg>
                                    <p>Crie um novo chat para come√ßar a conversar.</p>
                                </div>
                            </div>
                        </div>
                        <div id="attachment-preview-container" class="p-2 border-t border-[var(--border-color)] hidden"></div>
                        <div class="flex flex-row items-center pt-4 border-t border-[var(--border-color)] space-x-2">
                            <button id="attachFileBtn" class="p-3 rounded-full hover:bg-[var(--bg-tertiary)] flex-shrink-0 text-[var(--text-secondary)]" title="Anexar Imagem">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                                </svg>
                            </button>
                            <input type="file" id="file-input" class="hidden" accept="image/*">
                            <div class="flex-grow relative input-container">
                                <textarea id="userInput" class="w-full border border-[var(--border-color)] bg-[var(--bg-tertiary)] rounded-xl focus:outline-none focus:border-indigo-500 p-3 pr-12 text-[var(--text-primary)] resize-none" placeholder="Digite sua mensagem..." rows="1"></textarea>
                            </div>
                            <button id="sendButton" class="p-3 rounded-full bg-indigo-600 hover:bg-indigo-700 text-white flex-shrink-0">
                                <svg class="w-6 h-6 transform rotate-90" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"/>
                                </svg>
                            </button>
                        </div>
                     </div>
                </div>
            </div>
            
            <!-- Painel Direito -->
            <div id="right-panel-container" class="relative flex-col w-96 bg-[var(--bg-secondary)] p-2 transition-all duration-300 ease-in-out flex-shrink-0 flex">
                <!-- Resizer do Canvas -->
                <div id="canvas-resizer" class="canvas-resizer"></div>
                
                <div class="flex items-center justify-between p-2 border-b border-[var(--border-color)]">
                    <div class="flex space-x-1">
                        <button id="view-memory-btn" class="px-3 py-1 text-sm font-semibold rounded-md view-btn active">Mem√≥ria</button>
                        <button id="view-canvas-btn" class="px-3 py-1 text-sm font-semibold rounded-md view-btn">Canvas</button>
                    </div>
                    <div class="flex items-center space-x-1">
                        <button id="close-right-panel-btn" class="p-1 rounded-md hover:bg-[var(--bg-tertiary)] text-[var(--text-secondary)]" title="Fechar Painel">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div id="memory-panel" class="flex-grow flex-col flex">
                    <div class="p-2 flex space-x-2 items-center justify-between">
                        <input type="text" id="memorySearch" autocomplete="off" class="w-full border border-[var(--border-color)] bg-[var(--bg-tertiary)] rounded-lg px-3 py-2 text-sm text-[var(--text-primary)]" placeholder="Buscar...">
                        <button id="addMemoryBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-lg text-sm">Add</button>
                    </div>
                    <div class="p-2 flex space-x-1">
                        <button id="view-global-memory-btn" class="px-2 py-1 text-xs font-semibold rounded-md bg-gray-600 text-white">Global</button>
                        <button id="view-chat-memory-btn" class="px-2 py-1 text-xs font-semibold rounded-md bg-gray-700 text-gray-300">Chat</button>
                    </div>
                    <div id="memory-container" class="flex-grow overflow-y-auto custom-scrollbar"></div>
                </div>
                
                <div id="canvas-panel" class="flex-grow flex-col hidden">
                    <div class="canvas-toolbar">
                        <div class="toolbar-left">
                            <span id="canvas-file-type">üìÑ Documento</span>
                            <span id="canvas-line-count">0 linhas</span>
                        </div>
                        <div class="toolbar-right">
                            <button id="canvas-copy-btn" title="Copiar Conte√∫do">
                                üìã Copiar
                            </button>
                            <button id="canvas-download-btn" title="Baixar">
                                üíæ Baixar
                            </button>
                            <button id="canvas-clear-btn" title="Limpar">
                                üóëÔ∏è Limpar
                            </button>
                        </div>
                    </div>
                    <div id="canvas-content" class="flex-grow custom-scrollbar overflow-y-auto">
                        <div class="canvas-empty-state">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            <h3>Canvas Vazio</h3>
                            <p>Conte√∫do t√©cnico e documentos aparecer√£o aqui automaticamente</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bot√£o para expandir painel direito -->
    <button id="expand-right-panel-btn" class="expand-right-panel-btn panel-hidden p-2 bg-gray-700 rounded-md hover:bg-gray-600" title="Expandir Painel">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
    </button>
    
    <!-- Modais -->
    <div id="renameModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50">
        <div class="bg-[#2d2d30] p-6 rounded-lg shadow-xl w-1/3 text-[var(--text-primary)]">
            <h3 class="text-lg font-bold mb-4">Renomear Chat</h3>
            <input type="text" id="renameInput" class="w-full border border-gray-600 bg-[var(--bg-tertiary)] rounded-lg p-2 mb-4" placeholder="Novo nome do chat...">
            <div class="flex justify-end space-x-2">
                <button id="cancelRename" class="px-4 py-2 bg-gray-600 rounded-lg">Cancelar</button>
                <button id="confirmRename" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">Salvar</button>
            </div>
        </div>
    </div>
    
    <div id="renameTopicModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50">
        <div class="bg-[#2d2d30] p-6 rounded-lg shadow-xl w-1/3 text-[var(--text-primary)]">
            <h3 class="text-lg font-bold mb-4">Renomear T√≥pico</h3>
            <input type="text" id="renameTopicInput" class="w-full border border-gray-600 bg-[var(--bg-tertiary)] rounded-lg p-2 mb-4" placeholder="Novo nome do t√≥pico...">
            <div class="flex justify-end space-x-2">
                <button id="cancelRenameTopic" class="px-4 py-2 bg-gray-600 rounded-lg">Cancelar</button>
                <button id="confirmRenameTopic" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">Salvar</button>
            </div>
        </div>
    </div>
    
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50">
        <div class="bg-[#2d2d30] p-6 rounded-lg shadow-xl w-1/3 text-[var(--text-primary)]">
            <h3 class="text-lg font-bold mb-4 border-b border-[var(--border-color)] pb-2">Configura√ß√µes</h3>
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <label for="theme-toggle" class="font-medium">Tema Escuro</label>
                    <label for="theme-toggle" class="flex items-center cursor-pointer">
                        <div class="relative">
                            <input type="checkbox" id="theme-toggle" class="sr-only">
                            <div class="block bg-gray-600 w-10 h-6 rounded-full toggle-bg"></div>
                        </div>
                    </label>
                </div>
                <div class="flex items-center justify-between">
                    <label for="auto-memory-toggle-input" class="font-medium">Mem√≥ria Autom√°tica (Chat)</label>
                     <label for="auto-memory-toggle-input" class="flex items-center cursor-pointer">
                        <div class="relative">
                            <input type="checkbox" id="auto-memory-toggle-input" class="sr-only">
                            <div class="block bg-gray-600 w-10 h-6 rounded-full toggle-bg"></div>
                        </div>
                    </label>
                </div>
                 <div class="flex items-center justify-between">
                    <label for="dynamic-persona-toggle-input" class="font-medium">Persona Din√¢mica</label>
                     <label for="dynamic-persona-toggle-input" class="flex items-center cursor-pointer">
                        <div class="relative">
                            <input type="checkbox" id="dynamic-persona-toggle-input" class="sr-only">
                            <div class="block bg-gray-600 w-10 h-6 rounded-full toggle-bg"></div>
                        </div>
                    </label>
                </div>
            </div>
             <div class="flex justify-end mt-6">
                <button id="closeSettings" class="px-6 py-2 bg-indigo-600 text-white rounded-lg">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Outros Modais -->
    <div id="memoryModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50">
        <div class="bg-[#2d2d30] p-6 rounded-lg shadow-xl w-1/3 text-gray-200">
            <h3 class="text-lg font-bold mb-4">Salvar Mem√≥ria Manual</h3>
            <textarea id="memoryText" class="w-full border border-gray-600 bg-[var(--bg-tertiary)] rounded-lg p-2 h-32 mb-4" placeholder="Texto da mem√≥ria..."></textarea>
            <input type="text" id="memoryTopics" class="w-full border border-gray-600 bg-[var(--bg-tertiary)] rounded-lg p-2 mb-4" placeholder="T√≥picos (separados por v√≠rgula)...">
            <div class="flex items-center mb-4">
                <input type="checkbox" id="isGlobalMemory" class="mr-2">
                <label for="isGlobalMemory" class="text-sm">Salvar como mem√≥ria global</label>
            </div>
            <div class="flex justify-end space-x-2">
                <button id="cancelSave" class="px-4 py-2 bg-gray-600 rounded-lg">Cancelar</button>
                <button id="confirmSave" class="px-4 py-2 bg-green-600 text-white rounded-lg">Salvar</button>
            </div>
        </div>
    </div>
    
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50">
        <div class="bg-[#2d2d30] p-6 rounded-lg shadow-xl w-1/3 text-gray-200">
            <h3 class="text-lg font-bold mb-4">Confirmar A√ß√£o</h3>
            <p id="confirmMessage" class="mb-4">Voc√™ tem certeza?</p>
            <div class="flex justify-end space-x-2">
                <button id="cancelConfirm" class="px-4 py-2 bg-gray-600 rounded-lg">Cancelar</button>
                <button id="doConfirm" class="px-4 py-2 bg-red-600 text-white rounded-lg">Confirmar</button>
            </div>
        </div>
    </div>
    
    <div id="passwordModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50">
        <div class="bg-[#2d2d30] p-6 rounded-lg shadow-xl w-1/3 text-gray-200">
            <h3 class="text-lg font-bold mb-4">Ativar Modo Pro</h3>
            <p class="text-sm text-gray-400 mb-4">Digite a senha para usar o modelo Pro.</p>
            <input type="password" id="proPasswordInput" autocomplete="new-password" class="w-full border border-gray-600 bg-[var(--bg-tertiary)] rounded-lg p-2 mb-4" placeholder="Senha...">
            <div class="flex justify-end space-x-2">
                <button id="cancelPassword" class="px-4 py-2 bg-gray-600 rounded-lg">Cancelar</button>
                <button id="confirmPassword" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">Verificar</button>
            </div>
        </div>
    </div>
    
    <div id="notificationModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50">
        <div class="bg-[#2d2d30] p-6 rounded-lg shadow-xl w-1/3 text-gray-200 text-center">
            <p id="notificationMessage" class="mb-4 font-semibold"></p>
            <button id="closeNotification" class="px-6 py-2 bg-indigo-600 text-white rounded-lg">OK</button>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let appState = {
                activeChatId: null,
                chats: {},
                globalMemories: [],
                settings: {
                    theme: 'dark',
                    dynamicPersona: true,
                    isProMode: false,
                    proModeToken: null,
                    autoMemory: false
                },
                activeRightPanelView: 'memory',
                activeMemoryView: 'global',
                isCanvasMode: false,
                rightPanelWidth: 384
            };

            const elements = {
                body: document.body,
                emptyState: document.getElementById('empty-state'),
                mainInterface: document.getElementById('main-interface'),
                leftSidebar: document.getElementById('left-sidebar'),
                mainContainer: document.getElementById('main-container'),
                mainChatPanel: document.getElementById('main-chat-panel'),
                rightPanelContainer: document.getElementById('right-panel-container'),
                chatMessages: document.getElementById('chat-messages'),
                chatPlaceholder: document.getElementById('chat-placeholder'),
                memoryPanel: document.getElementById('memory-panel'),
                canvasPanel: document.getElementById('canvas-panel'),
                canvasContent: document.getElementById('canvas-content'),
                memoryContainer: document.getElementById('memory-container'),
                chatListContainer: document.getElementById('chat-list-container'),
                userInput: document.getElementById('userInput'),
                attachmentPreview: document.getElementById('attachment-preview-container'),
                
                createFirstChatBtn: document.getElementById('create-first-chat-btn'),
                newChatBtn: document.getElementById('newChatBtn'),
                collapseChatListBtn: document.getElementById('collapse-chat-list-btn'),
                expandChatListBtn: document.getElementById('expand-chat-list-btn'),
                sendButton: document.getElementById('sendButton'),
                proModeBtn: document.getElementById('proModeBtn'),
                viewMemoryBtn: document.getElementById('view-memory-btn'),
                viewCanvasBtn: document.getElementById('view-canvas-btn'),
                closeRightPanelBtn: document.getElementById('close-right-panel-btn'),
                expandRightPanelBtn: document.getElementById('expand-right-panel-btn'),
                attachFileBtn: document.getElementById('attachFileBtn'),
                fileInput: document.getElementById('file-input'),
                
                viewGlobalMemoryBtn: document.getElementById('view-global-memory-btn'),
                viewChatMemoryBtn: document.getElementById('view-chat-memory-btn'),
                
                passwordModal: document.getElementById('passwordModal'),
                proPasswordInput: document.getElementById('proPasswordInput'),
                confirmPassword: document.getElementById('confirmPassword'),
                cancelPassword: document.getElementById('cancelPassword'),
                notificationModal: document.getElementById('notificationModal'),
                notificationMessage: document.getElementById('notificationMessage'),
                closeNotification: document.getElementById('closeNotification'),
                
                memoryModal: document.getElementById('memoryModal'),
                memoryText: document.getElementById('memoryText'),
                memoryTopics: document.getElementById('memoryTopics'),
                isGlobalMemory: document.getElementById('isGlobalMemory'),
                cancelSave: document.getElementById('cancelSave'),
                confirmSave: document.getElementById('confirmSave'),
                
                confirmModal: document.getElementById('confirmModal'),
                confirmMessage: document.getElementById('confirmMessage'),
                cancelConfirm: document.getElementById('cancelConfirm'),
                doConfirm: document.getElementById('doConfirm'),
                
                renameModal: document.getElementById('renameModal'),
                renameInput: document.getElementById('renameInput'),
                confirmRename: document.getElementById('confirmRename'),
                cancelRename: document.getElementById('cancelRename'),
                
                renameTopicModal: document.getElementById('renameTopicModal'),
                renameTopicInput: document.getElementById('renameTopicInput'),
                confirmRenameTopic: document.getElementById('confirmRenameTopic'),
                cancelRenameTopic: document.getElementById('cancelRenameTopic'),
                
                settingsModal: document.getElementById('settingsModal'),
                settingsBtn: document.getElementById('settings-btn'),
                closeSettings: document.getElementById('closeSettings'),
                themeToggle: document.getElementById('theme-toggle'),
                autoMemoryToggle: document.getElementById('auto-memory-toggle-input'),
                dynamicPersonaToggle: document.getElementById('dynamic-persona-toggle-input'),
                
                canvasResizer: document.getElementById('canvas-resizer'),
                canvasFileType: document.getElementById('canvas-file-type'),
                canvasLineCount: document.getElementById('canvas-line-count'),
                canvasCopyBtn: document.getElementById('canvas-copy-btn'),
                canvasDownloadBtn: document.getElementById('canvas-download-btn'),
                canvasClearBtn: document.getElementById('canvas-clear-btn'),
                
                addMemoryBtn: document.getElementById('addMemoryBtn'),
                memorySearch: document.getElementById('memorySearch'),
                mainTitle: document.getElementById('main-title')
            };
            
            let attachedFile = null;
            let confirmCallback = null;
            let renameCallback = null;
            let renameTopicCallback = null;
            let isResizing = false;

            // Funcionalidade de redimensionamento do Canvas
            const initCanvasResizer = () => {
                let startX, startWidth;
                
                const startResize = (e) => {
                    isResizing = true;
                    startX = e.clientX;
                    startWidth = elements.rightPanelContainer.offsetWidth;
                    document.body.classList.add('canvas-resizing');
                    document.addEventListener('mousemove', doResize);
                    document.addEventListener('mouseup', stopResize);
                    e.preventDefault();
                };
                
                const doResize = (e) => {
                    if (!isResizing) return;
                    
                    const deltaX = startX - e.clientX;
                    const newWidth = startWidth + deltaX;
                    const minWidth = 384;
                    const maxWidth = window.innerWidth * 0.6;
                    
                    const clampedWidth = Math.max(minWidth, Math.min(maxWidth, newWidth));
                    
                    elements.rightPanelContainer.style.width = clampedWidth + 'px';
                    appState.rightPanelWidth = clampedWidth;
                    saveState();
                };
                
                const stopResize = () => {
                    isResizing = false;
                    document.body.classList.remove('canvas-resizing');
                    document.removeEventListener('mousemove', doResize);
                    document.removeEventListener('mouseup', stopResize);
                };
                
                elements.canvasResizer.addEventListener('mousedown', startResize);
            };

            const saveState = () => {
                const stateToSave = { ...appState, proModeToken: null };
                localStorage.setItem('phoenixChatState_v22', JSON.stringify(stateToSave));
            };

            const loadState = () => {
                const savedState = localStorage.getItem('phoenixChatState_v22');
                if (savedState) {
                    const parsedState = JSON.parse(savedState);
                    parsedState.settings = { ...appState.settings, ...parsedState.settings };
                    appState = { ...appState, ...parsedState };
                }
                
                if (appState.rightPanelWidth) {
                    elements.rightPanelContainer.style.width = appState.rightPanelWidth + 'px';
                }
                
                updateEmptyState();
                applySettings();
            };
            
            const updateEmptyState = () => {
                const hasChats = Object.keys(appState.chats).length > 0;
                if (!hasChats) {
                    elements.emptyState.classList.remove('panel-hidden');
                    elements.mainInterface.classList.add('opacity-0');
                    elements.mainInterface.classList.add('panel-hidden');
                    appState.activeChatId = null;
                } else {
                    elements.emptyState.classList.add('panel-hidden');
                    elements.mainInterface.classList.remove('panel-hidden');
                    setTimeout(() => elements.mainInterface.classList.remove('opacity-0'), 50);
                    if (!appState.activeChatId || !appState.chats[appState.activeChatId]) {
                        appState.activeChatId = Object.keys(appState.chats).sort((a,b) => b.split('-')[1] - a.split('-')[1])[0];
                    }
                    loadChat(appState.activeChatId);
                }
                renderChatList();
            };
            
            const createNewChat = (save = true) => {
                const newChatId = `chat-${Date.now()}`;
                appState.chats[newChatId] = { 
                    id: newChatId, 
                    name: "Novo Chat", 
                    history: [], 
                    memories: [], 
                    canvasContent: '' 
                };
                
                if (Object.keys(appState.chats).length === 1) {
                    elements.emptyState.classList.add('fade-out');
                    setTimeout(() => {
                        elements.emptyState.classList.add('panel-hidden');
                        elements.mainInterface.classList.remove('panel-hidden');
                        setTimeout(() => elements.mainInterface.classList.remove('opacity-0'), 50);
                    }, 500);
                }
                
                if (save) { 
                    switchChat(newChatId); 
                } else {
                    appState.activeChatId = newChatId;
                    updateEmptyState();
                }
            };

            const switchChat = (chatId) => {
                if (!appState.chats[chatId] || appState.activeChatId === chatId) return;
                appState.activeChatId = chatId;
                saveState();
                renderChatList();
                loadChat(chatId);
            };

            const loadChat = (chatId) => {
                const chat = appState.chats[chatId];
                if (!chat) {
                    updateEmptyState();
                    return;
                }

                elements.chatMessages.innerHTML = '';
                if (chat.history && chat.history.length > 0) {
                    elements.chatPlaceholder.classList.add('panel-hidden');
                    chat.history.forEach(msg => appendMessage(msg.text, msg.sender, msg.isPro, msg.usedContext, false));
                } else {
                    chat.history = [];
                    elements.chatPlaceholder.classList.remove('panel-hidden');
                }
                renderMemories();
                renderCanvas(chat.canvasContent, false);
                setProUI(appState.settings.isProMode && appState.settings.proModeToken);
                clearAttachment();
            };

            const deleteChat = (chatId) => {
                delete appState.chats[chatId];
                if (appState.activeChatId === chatId) { 
                    appState.activeChatId = null; 
                }
                saveState(); 
                updateEmptyState();
            };

            const renameChat = (chatId, newName) => {
                if (appState.chats[chatId] && newName) {
                    appState.chats[chatId].name = newName;
                    saveState();
                    renderChatList();
                }
            };
            
            const renderChatList = () => {
                elements.chatListContainer.innerHTML = '';
                const chats = Object.values(appState.chats).sort((a,b) => b.id.split('-')[1] - a.id.split('-')[1]);
                
                if (chats.length === 0) {
                    elements.chatListContainer.innerHTML = '<div class="p-4 text-center text-[var(--text-secondary)] text-sm">Nenhum chat criado ainda.</div>';
                    return;
                }
                
                chats.forEach(chat => {
                    const isActive = chat.id === appState.activeChatId;
                    const item = document.createElement('div');
                    item.className = `chat-list-item p-2 my-1 rounded-md cursor-pointer hover:bg-[var(--bg-tertiary)] flex justify-between items-center group ${isActive ? 'active' : ''}`;
                    item.innerHTML = `
                        <span class="flex-grow truncate" title="${chat.name}">${chat.name}</span> 
                        <div class="flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity flex items-center">
                            <button class="rename-chat-btn p-1 hover:text-blue-400" title="Renomear">&#9998;</button>
                            <button class="delete-chat-btn p-1 hover:text-red-400 text-lg" title="Apagar">&times;</button>
                        </div>
                    `;
                    item.addEventListener('click', (e) => { 
                        if (!e.target.closest('button')) switchChat(chat.id); 
                    });
                    item.querySelector('.rename-chat-btn').addEventListener('click', () => {
                        showRenameModal(chat.id, chat.name);
                    });
                    item.querySelector('.delete-chat-btn').addEventListener('click', () => { 
                        showConfirmationModal(`Tem certeza que deseja apagar o chat "${chat.name}"?`, () => deleteChat(chat.id)); 
                    });
                    elements.chatListContainer.appendChild(item);
                });
            };

            const appendMessage = (text, sender, proResponse = false, usedContext = [], shouldSave = true) => {
                const chat = appState.chats[appState.activeChatId];
                if (!chat) return;

                elements.chatPlaceholder.classList.add('panel-hidden');
                
                const contentHTML = sender === 'user' 
                    ? DOMPurify.sanitize(text.replace(/</g, "&lt;").replace(/>/g, "&gt;")) 
                    : DOMPurify.sanitize(marked.parse(text));
                
                const messageWrapper = document.createElement('div');
                messageWrapper.className = 'chat-message';
                
                let bubbleClass = 'chat-bubble-ai';
                if (sender === 'user') { 
                    bubbleClass = 'chat-bubble-user'; 
                } else if (proResponse) { 
                    bubbleClass = 'chat-bubble-ai-pro'; 
                }

                const alignment = sender === 'user' ? 'items-end' : 'items-start';
                const order = sender === 'user' ? 'order-2 items-end' : 'order-2 items-start';
                const avatar = sender === 'user' 
                    ? `<img src="https://placehold.co/40x40/3B82F6/FFFFFF?text=Vc" alt="User" class="w-8 h-8 rounded-full order-2">` 
                    : `<img src="https://placehold.co/40x40/5F6368/FFFFFF?text=IA" alt="AI" class="w-8 h-8 rounded-full order-1">`;
                
                const saveButtonHTML = (sender === 'ai' && text.trim()) 
                    ? `<button class="save-memory-btn mt-2 text-xs bg-green-600 hover:bg-green-700 text-white font-semibold py-1 px-3 rounded-full">Salvar</button>` 
                    : '';
                const contextHTML = (usedContext && usedContext.length > 0 && sender === 'ai') 
                    ? `<div class="text-xs text-[var(--text-secondary)] mt-2 border-t border-[var(--border-color)] pt-1">Contexto usado: ${usedContext.join(', ')}</div>` 
                    : '';
                
                messageWrapper.innerHTML = `
                    <div class="flex ${alignment}">
                        <div class="flex flex-col space-y-2 text-md max-w-3xl mx-2 ${order}">
                            <div>
                                <div class="px-4 py-2 rounded-lg inline-block ${sender === 'user' ? 'rounded-br-none' : 'rounded-bl-none'} ${bubbleClass}">
                                    <div class="markdown-content">${contentHTML}</div>
                                    ${contextHTML}
                                </div>
                                ${saveButtonHTML}
                            </div>
                        </div>
                        ${avatar}
                    </div>`;
                
                elements.chatMessages.appendChild(messageWrapper);
                elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;

                if (sender === 'ai' && text.trim()) {
                    const saveBtn = messageWrapper.querySelector('.save-memory-btn');
                    if (saveBtn) {
                        saveBtn.addEventListener('click', () => openMemoryModal(text));
                    }
                }

                if (shouldSave) {
                    chat.history.push({ text, sender, isPro: proResponse, usedContext });
                    if (chat.history.length === 1 && sender === 'user') {
                        const newName = text.substring(0, 25) + (text.length > 25 ? '...' : '');
                        renameChat(chat.id, newName);
                    }
                    saveState();
                }
                return messageWrapper;
            };

            const renderCanvas = (content, shouldSave = true) => {
                const chat = appState.chats[appState.activeChatId];
                if(!chat) return;
                
                if (!content || content.trim() === '') {
                    elements.canvasContent.innerHTML = `
                        <div class="canvas-empty-state">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            <h3>Canvas Vazio</h3>
                            <p>Conte√∫do t√©cnico e documentos aparecer√£o aqui automaticamente</p>
                        </div>
                    `;
                    elements.canvasFileType.textContent = 'üìÑ Documento';
                    elements.canvasLineCount.textContent = '0 linhas';
                } else {
                    // Detectar tipo de arquivo
                    let fileType = 'üìÑ Documento';
                    if (content.includes('```javascript') || content.includes('```js')) fileType = 'üü® JavaScript';
                    else if (content.includes('```python') || content.includes('```py')) fileType = 'üêç Python';
                    else if (content.includes('```html')) fileType = 'üåê HTML';
                    else if (content.includes('```css')) fileType = 'üé® CSS';
                    else if (content.includes('```json')) fileType = 'üìã JSON';
                    else if (content.includes('```')) fileType = 'üíª C√≥digo';
                    
                    // Contar linhas
                    const lineCount = content.split('\n').length;
                    
                    // Renderizar como documento estilizado
                    const parsedContent = DOMPurify.sanitize(marked.parse(content));
                    
                    elements.canvasContent.innerHTML = `
                        <div class="canvas-document">
                            <div class="canvas-document-header">
                                <h3 class="font-bold text-lg">${fileType}</h3>
                                <span class="text-sm text-[var(--text-secondary)]">${lineCount} linhas</span>
                            </div>
                            <div class="canvas-document-content">
                                ${parsedContent}
                            </div>
                        </div>
                    `;
                    
                    elements.canvasFileType.textContent = fileType;
                    elements.canvasLineCount.textContent = `${lineCount} linhas`;
                    
                    // Aplicar syntax highlighting se Prism estiver dispon√≠vel
                    if (typeof Prism !== 'undefined') {
                        Prism.highlightAllUnder(elements.canvasContent);
                    }
                }
                
                if (shouldSave) {
                    chat.canvasContent = content;
                    saveState();
                }
            };

            const getCurrentMemories = () => {
                if (appState.activeMemoryView === 'global') {
                    return appState.globalMemories;
                } else {
                    const chat = appState.chats[appState.activeChatId];
                    return chat ? chat.memories : [];
                }
            };

            const moveMemoryToGlobal = (memoryId) => {
                const chat = appState.chats[appState.activeChatId];
                if (!chat) return;
                
                const memoryIndex = chat.memories.findIndex(mem => mem.id === memoryId);
                if (memoryIndex !== -1) {
                    const memory = chat.memories.splice(memoryIndex, 1)[0];
                    memory.id = `mem-global-${Date.now()}`;
                    appState.globalMemories.push(memory);
                    saveState();
                    renderMemories();
                    showNotification('Mem√≥ria movida para o escopo global.');
                }
            };

            const renderMemories = () => {
                const memories = getCurrentMemories();
                const isGlobal = appState.activeMemoryView === 'global';
                
                if (!memories || memories.length === 0) {
                    elements.memoryContainer.innerHTML = `<div class="p-4 text-center text-gray-500 text-sm">Nenhuma mem√≥ria salva.</div>`;
                    return;
                }

                elements.memoryContainer.innerHTML = '';
                const searchTerm = elements.memorySearch.value.toLowerCase();
                
                const filteredMemories = memories.filter(mem => mem.text.toLowerCase().includes(searchTerm));

                const groupedByTopic = filteredMemories.reduce((acc, mem) => {
                    (mem.topics || []).forEach(topic => {
                        if (!acc[topic]) acc[topic] = [];
                        acc[topic].push(mem);
                    });
                    return acc;
                }, {});

                const sortedTopics = Object.keys(groupedByTopic).sort();

                if (sortedTopics.length === 0) {
                    elements.memoryContainer.innerHTML = `<div class="p-4 text-center text-gray-500 text-sm">Nenhuma mem√≥ria encontrada.</div>`;
                    return;
                }

                sortedTopics.forEach(topic => {
                    const details = document.createElement('details');
                    details.className = 'p-2';
                    details.open = searchTerm.length > 0;

                    const summary = document.createElement('summary');
                    summary.className = 'font-bold text-lg cursor-pointer p-2 bg-gray-700 rounded-lg flex justify-between items-center memory-topic-header';
                    const topicMemories = groupedByTopic[topic];
                    const totalChars = topicMemories.reduce((sum, mem) => sum + mem.text.length, 0);
                    let warningHTML = (totalChars > 5000) 
                        ? `<span class="text-yellow-400" title="T√≥pico grande. Considere dividi-lo.">‚ö†Ô∏è</span>` 
                        : '';
                    summary.innerHTML = `<span>${topic.charAt(0).toUpperCase() + topic.slice(1)}</span> <div class="flex items-center space-x-2">${warningHTML}<button class="rename-topic-btn p-1 hover:text-blue-400 text-xs" title="Renomear T√≥pico">&#9998;</button><button class="delete-topic-btn p-1 hover:text-red-400 text-xs" title="Apagar T√≥pico">&times;</button></div>`;
                    
                    const topicContent = document.createElement('div');
                    topicContent.className = 'pl-4 pt-2';

                    topicMemories.forEach(mem => {
                        const memEl = document.createElement('div');
                        memEl.className = 'memory-item p-3 mb-2 bg-gray-800 border-l-4 border-yellow-500 rounded-r-lg shadow-sm';
                        
                        const moveButtonHTML = !isGlobal 
                            ? `<button class="move-to-global-btn" data-id="${mem.id}" title="Mover para Global">üåê</button>` 
                            : '';
                        
                        memEl.innerHTML = `
                            <p class="text-sm text-gray-300">${mem.text}</p>
                            <div class="flex justify-between items-center mt-2">
                                <button class="delete-memory-btn text-xs text-red-500 hover:text-red-400 font-semibold" data-id="${mem.id}">Excluir</button>
                                ${moveButtonHTML}
                            </div>
                        `;
                        topicContent.appendChild(memEl);
                    });
                    
                    details.appendChild(summary);
                    details.appendChild(topicContent);
                    elements.memoryContainer.appendChild(details);

                    summary.querySelector('.rename-topic-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        showRenameTopicModal(topic);
                    });

                    summary.querySelector('.delete-topic-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        showConfirmationModal(`Tem certeza que deseja apagar o t√≥pico "${topic}" e todas as suas mem√≥rias?`, () => deleteTopic(topic));
                    });
                });

                elements.memoryContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('delete-memory-btn')) {
                        const memoryId = e.target.getAttribute('data-id');
                        showConfirmationModal('Tem certeza que deseja excluir esta mem√≥ria?', () => deleteMemory(memoryId));
                    } else if (e.target.classList.contains('move-to-global-btn')) {
                        const memoryId = e.target.getAttribute('data-id');
                        moveMemoryToGlobal(memoryId);
                    }
                });
            };
            
            const clearAttachment = () => {
                attachedFile = null;
                elements.attachmentPreview.innerHTML = '';
                elements.attachmentPreview.classList.add('hidden');
                elements.fileInput.value = '';
            };

            const handleFileDrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                elements.userInput.classList.remove('drag-over');
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    handleFileAttachment(file);
                }
            };

            const handleFileAttachment = (file) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const base64Data = e.target.result.split(',')[1];
                    attachedFile = {
                        type: file.type,
                        data: base64Data
                    };
                    
                    elements.attachmentPreview.innerHTML = `
                        <div class="flex items-center space-x-2">
                            <img src="${e.target.result}" alt="Preview" class="w-16 h-16 object-cover rounded">
                            <span class="text-sm">${file.name}</span>
                            <button id="removeAttachment" class="text-red-500 hover:text-red-700">&times;</button>
                        </div>
                    `;
                    elements.attachmentPreview.classList.remove('hidden');
                    
                    document.getElementById('removeAttachment').addEventListener('click', clearAttachment);
                };
                reader.readAsDataURL(file);
            };

            const handleSend = async () => {
                if (!appState.activeChatId) {
                    createNewChat();
                }
                
                const chat = appState.chats[appState.activeChatId];
                if (!chat) return;

                const query = elements.userInput.value.trim();
                if (!query && !attachedFile) return;

                appendMessage(query, 'user');
                elements.userInput.value = '';
                elements.userInput.style.height = 'auto';
                elements.userInput.classList.remove('has-scroll');

                const imagePayload = attachedFile ? {
                    mimeType: attachedFile.type,
                    data: attachedFile.data
                } : null;
                
                clearAttachment();
                
                const aiMessageWrapper = appendMessage('', 'ai', appState.settings.isProMode, [], false);
                const aiContentDiv = aiMessageWrapper.querySelector('.markdown-content');
                aiContentDiv.innerHTML = '<span class="blinking-cursor"></span>';

                try {
                    const allMemories = [...appState.globalMemories, ...(chat.memories || [])];
                    
                    const payload = { 
                        action: 'chat',
                        prompt: query, 
                        isPro: appState.settings.isProMode, 
                        proToken: appState.settings.proModeToken,
                        isAutoMemory: appState.settings.autoMemory,
                        memories: allMemories,
                        image: imagePayload,
                        useDynamicPersona: appState.settings.dynamicPersona
                    };
                    
                    const response = await fetch('/api/gemini', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        if (response.status === 401) { 
                            setProUI(false); 
                            showNotification("Senha do Modo Pro incorreta."); 
                        }
                        throw new Error(errorData.error || 'Falha na resposta do backend');
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let fullResponse = '';
                    let finalData = null;

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split('\n');

                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const data = JSON.parse(line.slice(6));
                                    if (data.type === 'chunk') {
                                        fullResponse += data.text;
                                        aiContentDiv.innerHTML = DOMPurify.sanitize(marked.parse(fullResponse + '<span class="blinking-cursor"></span>'));
                                        elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
                                    } else if (data.type === 'complete') {
                                        finalData = data;
                                    } else if (data.type === 'error') {
                                        throw new Error(data.error);
                                    }
                                } catch (e) {
                                    // ignore parse errors
                                }
                            }
                        }
                    }
                    
                    aiContentDiv.innerHTML = DOMPurify.sanitize(marked.parse(fullResponse));
                    
                    if (finalData) {
                        chat.history.push({ text: fullResponse, sender: 'ai', isPro: appState.settings.isProMode, usedContext: finalData.usedContext });
                        if (finalData.canvasContent && finalData.canvasContent.trim()) {
                            renderCanvas(finalData.canvasContent);
                            if (appState.activeRightPanelView !== 'canvas') {
                                switchView('canvas');
                            }
                        }
                        if (finalData.newMemory) {
                            chat.memories.push(finalData.newMemory);
                            saveState();
                            if (appState.activeMemoryView === 'chat') {
                                renderMemories();
                            }
                        }
                        saveState();
                    }

                } catch (error) {
                    aiContentDiv.innerHTML = `<span class="text-red-500">**Erro:** ${error.message}</span>`;
                }
            };
            
            const switchView = (view) => {
                appState.activeRightPanelView = view;
                const isMemory = view === 'memory';
                elements.memoryPanel.classList.toggle('hidden', !isMemory);
                elements.memoryPanel.classList.toggle('flex', isMemory);
                elements.canvasPanel.classList.toggle('hidden', isMemory);
                elements.canvasPanel.classList.toggle('flex', !isMemory);
                elements.viewMemoryBtn.classList.toggle('active', isMemory);
                elements.viewCanvasBtn.classList.toggle('active', !isMemory);
                
                if (!isMemory) {
                    elements.body.classList.add('canvas-mode');
                } else {
                    elements.body.classList.remove('canvas-mode');
                }
                
                saveState();
            };

            const switchMemoryView = (view) => {
                appState.activeMemoryView = view;
                const isGlobal = view === 'global';
                elements.viewGlobalMemoryBtn.className = `px-2 py-1 text-xs font-semibold rounded-md ${isGlobal ? 'bg-gray-600 text-white' : 'bg-gray-700 text-gray-300'}`;
                elements.viewChatMemoryBtn.className = `px-2 py-1 text-xs font-semibold rounded-md ${!isGlobal ? 'bg-gray-600 text-white' : 'bg-gray-700 text-gray-300'}`;
                renderMemories();
                saveState();
            };
            
            const showConfirmationModal = (message, onConfirm) => {
                elements.confirmMessage.textContent = message;
                confirmCallback = onConfirm;
                elements.confirmModal.classList.remove('hidden');
            };

            const showNotification = (message) => {
                elements.notificationMessage.textContent = message;
                elements.notificationModal.classList.remove('hidden');
            };
            
            const openMemoryModal = (rawText = null) => {
                elements.memoryText.value = rawText || '';
                elements.memoryTopics.value = '';
                elements.isGlobalMemory.checked = appState.activeMemoryView === 'global';
                elements.memoryModal.classList.remove('hidden');
                elements.memoryText.focus();
            };

            const saveMemory = () => {
                const text = elements.memoryText.value.trim();
                const topics = elements.memoryTopics.value.split(',').map(t => t.trim().toLowerCase()).filter(Boolean);
                const isGlobal = elements.isGlobalMemory.checked;
                
                if (!text || topics.length === 0) { 
                    alert('Texto e t√≥pico s√£o obrigat√≥rios.'); 
                    return; 
                }
                
                const newMemory = { 
                    id: `mem-${Date.now()}`, 
                    text, 
                    topics,
                    tokenCount: Math.ceil(text.length / 4),
                    lastAccessed: Date.now()
                };
                
                if (isGlobal) {
                    appState.globalMemories.push(newMemory);
                } else {
                    if (!appState.activeChatId) createNewChat();
                    const chat = appState.chats[appState.activeChatId];
                    if (chat) {
                        if (!chat.memories) chat.memories = [];
                        chat.memories.push(newMemory);
                    }
                }
                
                saveState();
                renderMemories();
                elements.memoryModal.classList.add('hidden');
            };
            
            const deleteMemory = (memoryId) => {
                const memories = getCurrentMemories();
                const index = memories.findIndex(mem => mem.id === memoryId);
                if (index !== -1) {
                    memories.splice(index, 1);
                    saveState();
                    renderMemories();
                }
            };

            const deleteTopic = (topicName) => {
                const memories = getCurrentMemories();
                memories.forEach(mem => { 
                    mem.topics = mem.topics.filter(t => t !== topicName); 
                });
                const filteredMemories = memories.filter(mem => mem.topics.length > 0);
                
                if (appState.activeMemoryView === 'global') {
                    appState.globalMemories = filteredMemories;
                } else {
                    const chat = appState.chats[appState.activeChatId];
                    if (chat) {
                        chat.memories = filteredMemories;
                    }
                }
                
                saveState();
                renderMemories();
            };

            const renameTopic = (oldName, newName) => {
                if (!newName || newName.trim() === '') return;
                
                const memories = getCurrentMemories();
                memories.forEach(mem => {
                    mem.topics = mem.topics.map(t => t === oldName ? newName.toLowerCase() : t);
                });
                
                saveState();
                renderMemories();
            };

            const setProUI = (active) => {
                appState.settings.isProMode = active;
                elements.mainTitle.textContent = active ? "Phoenix Chat (PRO)" : "Phoenix Chat";
                const svg = elements.proModeBtn.querySelector('svg');
                if (active) { 
                    svg.classList.add('text-yellow-400'); 
                } else { 
                    svg.classList.remove('text-yellow-400'); 
                    appState.settings.proModeToken = null; 
                }
                saveState();
            };

            const verifyPassword = async () => {
                const password = elements.proPasswordInput.value;
                if (!password) return;
                try {
                    const response = await fetch('/api/gemini', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'verifyPassword', proToken: password })
                    });
                    const result = await response.json();
                    elements.passwordModal.classList.add('hidden');
                    elements.proPasswordInput.value = '';
                    if (result.success) {
                        appState.settings.proModeToken = password;
                        setProUI(true);
                        showNotification("Modo Pro ativado com sucesso!");
                    } else {
                        setProUI(false);
                        showNotification("Senha incorreta.");
                    }
                } catch (e) {
                    elements.passwordModal.classList.add('hidden');
                    elements.proPasswordInput.value = '';
                    showNotification("Erro ao verificar a senha.");
                }
            };
            
            const applySettings = () => {
                if(appState.settings.theme === 'dark'){
                    document.documentElement.classList.add('dark'); // Corrigido para document.documentElement
                    elements.themeToggle.checked = true;
                } else {
                    document.documentElement.classList.remove('dark');
                    elements.themeToggle.checked = false;
                }
                elements.dynamicPersonaToggle.checked = appState.settings.dynamicPersona;
                elements.autoMemoryToggle.checked = appState.settings.autoMemory;
                switchView(appState.activeRightPanelView || 'memory');
                switchMemoryView(appState.activeMemoryView || 'global');
            };

            const showRenameModal = (chatId, currentName) => {
                elements.renameInput.value = currentName;
                renameCallback = (newName) => renameChat(chatId, newName);
                elements.renameModal.classList.remove('hidden');
                elements.renameInput.focus();
            };

            const showRenameTopicModal = (currentName) => {
                elements.renameTopicInput.value = currentName;
                renameTopicCallback = (newName) => renameTopic(currentName, newName);
                elements.renameTopicModal.classList.remove('hidden');
                elements.renameTopicInput.focus();
            };

            // Canvas functions
            const copyCanvasContent = () => {
                const chat = appState.chats[appState.activeChatId];
                if (chat && chat.canvasContent) {
                    navigator.clipboard.writeText(chat.canvasContent).then(() => {
                        showNotification('Conte√∫do copiado para a √°rea de transfer√™ncia!');
                    });
                }
            };

            const downloadCanvasContent = () => {
                const chat = appState.chats[appState.activeChatId];
                if (chat && chat.canvasContent) {
                    const blob = new Blob([chat.canvasContent], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `canvas-${Date.now()}.txt`;
                    a.click();
                    URL.revokeObjectURL(url);
                }
            };

            const clearCanvasContent = () => {
                showConfirmationModal('Tem certeza que deseja limpar o Canvas?', () => {
                    renderCanvas('');
                });
            };

            // Event Listeners
            elements.createFirstChatBtn.addEventListener('click', () => createNewChat());
            elements.newChatBtn.addEventListener('click', () => createNewChat());
            elements.sendButton.addEventListener('click', handleSend);
            elements.userInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSend();
                }
            });

            elements.userInput.addEventListener('input', () => {
                const textarea = elements.userInput;
                textarea.style.height = 'auto';
                const newHeight = Math.min(textarea.scrollHeight, 200);
                textarea.style.height = newHeight + 'px';
                
                // S√≥ mostrar scrollbar se necess√°rio
                if (textarea.scrollHeight > 200) {
                    textarea.classList.add('has-scroll');
                } else {
                    textarea.classList.remove('has-scroll');
                }
            });

            elements.proModeBtn.addEventListener('click', () => {
                if (appState.settings.isProMode) {
                    setProUI(false);
                } else {
                    elements.passwordModal.classList.remove('hidden');
                    elements.proPasswordInput.focus();
                }
            });

            elements.confirmPassword.addEventListener('click', verifyPassword);
            elements.cancelPassword.addEventListener('click', () => {
                elements.passwordModal.classList.add('hidden');
                elements.proPasswordInput.value = '';
            });

            elements.closeNotification.addEventListener('click', () => {
                elements.notificationModal.classList.add('hidden');
            });

            elements.confirmSave.addEventListener('click', saveMemory);
            elements.cancelSave.addEventListener('click', () => {
                elements.memoryModal.classList.add('hidden');
            });

            elements.doConfirm.addEventListener('click', () => {
                if (confirmCallback) confirmCallback();
                elements.confirmModal.classList.add('hidden');
                confirmCallback = null;
            });
            elements.cancelConfirm.addEventListener('click', () => {
                elements.confirmModal.classList.add('hidden');
                confirmCallback = null;
            });

            elements.confirmRename.addEventListener('click', () => {
                const newName = elements.renameInput.value.trim();
                if (newName && renameCallback) {
                    renameCallback(newName);
                }
                elements.renameModal.classList.add('hidden');
                renameCallback = null;
            });
            elements.cancelRename.addEventListener('click', () => {
                elements.renameModal.classList.add('hidden');
                renameCallback = null;
            });

            elements.confirmRenameTopic.addEventListener('click', () => {
                const newName = elements.renameTopicInput.value.trim();
                if (newName && renameTopicCallback) {
                    renameTopicCallback(newName);
                }
                elements.renameTopicModal.classList.add('hidden');
                renameTopicCallback = null;
            });
            elements.cancelRenameTopic.addEventListener('click', () => {
                elements.renameTopicModal.classList.add('hidden');
                renameTopicCallback = null;
            });

            elements.settingsBtn.addEventListener('click', () => {
                elements.settingsModal.classList.remove('hidden');
            });
            elements.closeSettings.addEventListener('click', () => {
                elements.settingsModal.classList.add('hidden');
            });

            elements.themeToggle.addEventListener('change', () => {
                appState.settings.theme = elements.themeToggle.checked ? 'dark' : 'light';
                applySettings();
                saveState();
            });

            elements.autoMemoryToggle.addEventListener('change', () => {
                appState.settings.autoMemory = elements.autoMemoryToggle.checked;
                saveState();
            });

            elements.dynamicPersonaToggle.addEventListener('change', () => {
                appState.settings.dynamicPersona = elements.dynamicPersonaToggle.checked;
                saveState();
            });

            elements.viewMemoryBtn.addEventListener('click', () => switchView('memory'));
            elements.viewCanvasBtn.addEventListener('click', () => switchView('canvas'));
            
            elements.viewGlobalMemoryBtn.addEventListener('click', () => switchMemoryView('global'));
            elements.viewChatMemoryBtn.addEventListener('click', () => switchMemoryView('chat'));
            
            elements.closeRightPanelBtn.addEventListener('click', () => {
                elements.rightPanelContainer.classList.add('right-panel-collapsed');
                elements.expandRightPanelBtn.classList.remove('panel-hidden');
            });

            elements.expandRightPanelBtn.addEventListener('click', () => {
                elements.rightPanelContainer.classList.remove('right-panel-collapsed');
                elements.expandRightPanelBtn.classList.add('panel-hidden');
            });

            elements.addMemoryBtn.addEventListener('click', () => openMemoryModal());
            elements.memorySearch.addEventListener('input', renderMemories);

            elements.attachFileBtn.addEventListener('click', () => {
                elements.fileInput.click();
            });

            elements.fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    handleFileAttachment(file);
                }
            });

            // Drag and Drop
            elements.userInput.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                elements.userInput.classList.add('drag-over');
            });
            elements.userInput.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                elements.userInput.classList.remove('drag-over');
            });
            elements.userInput.addEventListener('drop', handleFileDrop);

            elements.collapseChatListBtn.addEventListener('click', () => {
                elements.leftSidebar.classList.add('panel-hidden');
                elements.expandChatListBtn.classList.remove('panel-hidden');
            });

            elements.expandChatListBtn.addEventListener('click', () => {
                elements.leftSidebar.classList.remove('panel-hidden');
                elements.expandChatListBtn.classList.add('panel-hidden');
            });

            // Canvas event listeners
            elements.canvasCopyBtn.addEventListener('click', copyCanvasContent);
            elements.canvasDownloadBtn.addEventListener('click', downloadCanvasContent);
            elements.canvasClearBtn.addEventListener('click', clearCanvasContent);

            // Inicializar redimensionamento do Canvas
            initCanvasResizer();
            
            loadState();
        });
    </script>
</body>
</html>
